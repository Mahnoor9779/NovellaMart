@page "/profile"
@using System.IO
@using System.Text.Json
@using NovellaMart
@using NovellaMart.Core.BL.Model_Classes
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@rendermode RenderMode.InteractiveServer

<PageTitle>Profile - NovellaMart</PageTitle>

@* ⚠️ KEEP THIS STYLE HERE 
   If you move this to app.css, your Navbar will disappear 
   from the Home page and Login page too! 
*@
<style>
    .navbar-custom, .top-announcement {
        display: none !important;
    }
</style>

<div class="profile-wrapper">
    <aside class="sidebar">
        <div class="sidebar-user">
            <img src="@GetProfileImage(50)" style="width:50px; height:50px; border-radius:50%; object-fit:cover; margin-right:15px;" />
            <div class="user-info">
                <h4>@username</h4>
                <p>@role</p>
            </div>
        </div>
        <ul class="nav-links">
            <li class="nav-item active"><i class="fas fa-user-circle me-2"></i> Profile</li>
            <li class="nav-item"><i class="fas fa-shopping-bag me-2"></i> My Orders</li>
            <li class="nav-item" @onclick="Logout" style="color:#d63384; margin-top: 30px; font-weight:bold; cursor:pointer;"><i class="fas fa-sign-out-alt me-2"></i> Logout</li>
        </ul>
    </aside>

    <main class="profile-content">
        <div class="page-header"><h2 class="page-title">My Profile</h2></div>
        <div class="profile-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <div style="position: relative; width: 100px; height: 100px;">
                    <img src="@GetProfileImage(128)" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border: 4px solid #fff; box-shadow: 0 0 0 2px #ec4899;" />
                    @if (isEditing)
                    {
                        <label class="camera-upload"><i class="fas fa-camera" style="font-size:14px;"></i><InputFile OnChange="HandleFileSelected" style="display:none;" /></label>
                    }
                </div>
                @if (!isEditing)
                {
                    <button class="edit-btn" @onclick="EnableEditMode">Edit Profile</button>
                }
            </div>

            <div class="form-grid">
                <div class="input-group"><label>Username</label><input type="text" class="input-field" @bind="username" disabled /></div>
                <div class="input-group"><label>Password</label><input type="text" class="input-field" @bind="password" disabled="@(!isEditing)" /></div>
                <div class="input-group"><label>First Name</label><input type="text" class="input-field" @bind="firstName" disabled="@(!isEditing)" /></div>
                <div class="input-group"><label>Last Name</label><input type="text" class="input-field" @bind="lastName" disabled="@(!isEditing)" /></div>
                <div class="input-group full-width"><label>Email</label><input type="email" class="input-field" @bind="email" disabled="@(!isEditing)" /></div>

                <div class="section-label">Contact Details</div>
                <div class="input-group full-width"><label>Phone</label><input type="text" class="input-field" @bind="phone" disabled="@(!isEditing)" /></div>
                <div class="input-group full-width"><label>Address</label><input type="text" class="input-field" @bind="address" disabled="@(!isEditing)" /></div>
                <div class="input-group"><label>City</label><input type="text" class="input-field" @bind="city" disabled="@(!isEditing)" /></div>
                <div class="input-group"><label>Zip Code</label><input type="text" class="input-field" @bind="zipCode" disabled="@(!isEditing)" /></div>
            </div>

            @if (isEditing)
            {
                <button class="save-btn" @onclick="SaveChanges">@if (isSaved) {
                <span>✔ Saved!</span>
            }
            else
            {

                <span>Save Changes</span>
            }
</button>
            <button @onclick="CancelEdit" style="float:right; margin-top:20px; margin-right:10px; background:none; border:none; color:#666; font-weight:600;">Cancel</button>
                        }
            <div style="clear:both;"></div>
        </div>
    </main>
</div>

@code {
    private string username = "Guest", email = "", password = "", role = "Member";
    private string firstName = "", lastName = "", phone = "", address = "", city = "", zipCode = "", profilePicture = "";
    private bool isEditing = false, isSaved = false;
    private string filePath = "wwwroot/Files/users.json";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserData();
            StateHasChanged();
        }
    }

    private void EnableEditMode() => isEditing = true;
    private async Task CancelEdit() { await LoadUserData(); isEditing = false; }

    private string GetProfileImage(int size) => !string.IsNullOrEmpty(profilePicture) ? profilePicture : $"https://ui-avatars.com/api/?name={username}&background=fce7f3&color=ec4899&size={size}";

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var resized = await file.RequestImageFileAsync(file.ContentType, 300, 300);
            var buffer = new byte[resized.Size];
            await resized.OpenReadStream().ReadAsync(buffer);
            profilePicture = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task LoadUserData()
    {
        string currentUser = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "currentUser");

        if (string.IsNullOrEmpty(currentUser))
        {
            Nav.NavigateTo("/login");
            return;
        }

        if (File.Exists(filePath))
        {
            var json = await File.ReadAllTextAsync(filePath);
            var users = JsonSerializer.Deserialize<List<UserBL>>(json);
            var myUser = users?.FirstOrDefault(u => u.username == currentUser);

            if (myUser != null)
            {
                username = myUser.username ?? ""; email = myUser.email ?? ""; password = myUser.password ?? "";
                firstName = myUser.firstName ?? ""; lastName = myUser.lastName ?? ""; role = myUser.role ?? "Member";
                phone = myUser.phoneNumber ?? ""; address = myUser.address ?? ""; city = myUser.city ?? "";
                zipCode = myUser.zipCode ?? ""; profilePicture = myUser.profilePicture ?? "";
            }
        }
    }

    private async Task SaveChanges()
    {
        List<UserBL> users = new();
        if (File.Exists(filePath))
        {
            var json = await File.ReadAllTextAsync(filePath);
            users = JsonSerializer.Deserialize<List<UserBL>>(json) ?? new List<UserBL>();
        }

        var existing = users.FirstOrDefault(u => u.username == username);
        if (existing != null)
        {
            existing.email = email; existing.password = password; existing.firstName = firstName; existing.lastName = lastName;
            existing.phoneNumber = phone; existing.address = address; existing.city = city; existing.zipCode = zipCode; existing.profilePicture = profilePicture;
        }

        await File.WriteAllTextAsync(filePath, JsonSerializer.Serialize(users, new JsonSerializerOptions { WriteIndented = true }));
        isSaved = true; await Task.Delay(1000); isSaved = false; isEditing = false;
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "currentUser");
        Nav.NavigateTo("/login");
    }
}