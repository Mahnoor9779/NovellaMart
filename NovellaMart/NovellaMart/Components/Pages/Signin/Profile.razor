@page "/profile"
@using System.IO
@using System.Text.Json
@using NovellaMart
@using NovellaMart.Core.BL.Model_Classes
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@rendermode RenderMode.InteractiveServer
@inject NovellaMart.Core.BL.Services.ProductCatalogService CatalogService   
@inject NovellaMart.Core.BL.Services.CartService CartService

<PageTitle>Profile - NovellaMart</PageTitle>

<div class="profile-wrapper">
    <aside class="sidebar">
        <div class="sidebar-user">
            <img src="@GetProfileImage(50)" class="sidebar-avatar" />
            <div class="user-info">
                <h4>@username</h4>
                <p>@role</p>
            </div>
        </div>
        <ul class="nav-links">
            <li class="nav-item" @onclick='() => Nav.NavigateTo("/")'>
                <i class="fas fa-home me-2"></i> Home
            </li>
            <li class="nav-item active">
                <i class="fas fa-user-circle me-2"></i> Profile
            </li>
            <li class="nav-item" @onclick='() => Nav.NavigateTo("/orders")'>
                <i class="fas fa-shopping-bag me-2"></i> My Orders
            </li>
            <li class="nav-item @(Nav.Uri.Contains("notifications") ? "active" : "")" @onclick='() => Nav.NavigateTo("/notifications")'>
                <i class="fas fa-bell me-2"></i> Notifications
                @if (userNotifications.Any())
                {
                    <span class="badge rounded-pill bg-danger ms-2" style="font-size: 0.6rem;">@userNotifications.Count</span>
                }
            </li>
            <li class="nav-item logout-link" @onclick="Logout">
                <i class="fas fa-sign-out-alt me-2"></i> Logout
            </li>
        </ul>
    </aside>

    <main class="profile-content">
        <div style="padding-top: 40px;">
            <div class="page-header">
                <h2 class="page-title">My Profile</h2>
            </div>

            <div class="profile-card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:30px;">
                    <div style="position: relative; display: inline-block;">
                        <img src="@GetProfileImage(128)" class="large-avatar" />
                        @if (isEditing)
                        {
                            <label class="camera-upload">
                                <i class="fas fa-camera" style="font-size: 14px;"></i>
                                <InputFile OnChange="HandleFileSelected" style="display:none;" />
                            </label>
                        }
                    </div>

                    @if (!isEditing)
                    {
                        <button class="edit-btn" @onclick="EnableEditMode">Edit Profile</button>
                    }
                </div>

                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" class="input-field" @bind="username" disabled />
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" class="input-field" @bind="password" disabled="@(!isEditing)" />
                    </div>
                    <div class="input-group">
                        <label>First Name</label>
                        <input type="text" class="input-field" @bind="firstName" disabled="@(!isEditing)" />
                    </div>
                    <div class="input-group">
                        <label>Last Name</label>
                        <input type="text" class="input-field" @bind="lastName" disabled="@(!isEditing)" />
                    </div>
                    <div class="input-group" style="grid-column: span 2;">
                        <label>Email</label>
                        <input type="email" class="input-field" @bind="email" disabled="@(!isEditing)" />
                    </div>

                    <div style="grid-column: span 2; cursor: pointer;" @onclick="ToggleContact">
                        <div class="section-label" style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                            <span>Contact Details</span>
                            <i class="fas @(showContact ? "fa-chevron-up" : "fa-chevron-down")" style="font-size: 14px;"></i>
                        </div>
                    </div>

                    @if (showContact)
                    {
                        <div class="input-group" style="grid-column: span 2;">
                            <label>Phone</label>
                            <input type="text" class="input-field" @bind="phone" disabled="@(!isEditing)" />
                        </div>
                        <div class="input-group" style="grid-column: span 2;">
                            <label>Address</label>
                            <input type="text" class="input-field" @bind="address" disabled="@(!isEditing)" />
                        </div>
                        <div class="input-group">
                            <label>City</label>
                            <input type="text" class="input-field" @bind="city" disabled="@(!isEditing)" />
                        </div>
                        <div class="input-group">
                            <label>Zip Code</label>
                            <input type="text" class="input-field" @bind="zipCode" disabled="@(!isEditing)" />
                        </div>
                    }
                </div>

                @if (isEditing)
                {
                    <div style="margin-top: 30px; display: flex; justify-content: flex-end; align-items: center; gap: 15px;">
                        <button style="background: none; border: none; color: #888; cursor: pointer; font-weight: 600;" @onclick="CancelEdit">Cancel</button>
                        <button class="save-btn" @onclick="SaveChanges">
                            @(isSaved ? "✔ Saved!" : "Save Changes")
                        </button>
                    </div>
                }
            </div>
        </div>
    </main>
</div>

@code {
    private string username = "Guest", email = "", password = "", role = "Member";
    private string firstName = "", lastName = "", phone = "", address = "", city = "", zipCode = "", profilePicture = "";
    private bool isEditing = false, isSaved = false, showContact = true;
    private string filePath = "Core/DL/users.json";

    private List<NotificationBL> userNotifications = new List<NotificationBL>();
    [Inject] NovellaMart.Core.BL.Services.FlashSaleService LiveSaleService { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserData();
            await LoadNotifications();
            StateHasChanged();
        }
    }

    private void EnableEditMode() => isEditing = true;
    private void ToggleContact() => showContact = !showContact;
    private async Task CancelEdit() { await LoadUserData(); isEditing = false; }

    private string GetProfileImage(int size) => !string.IsNullOrEmpty(profilePicture) ? profilePicture : $"https://ui-avatars.com/api/?name={username}&background=fce7f3&color=ec4899&size={size}";

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            var resized = await file.RequestImageFileAsync(file.ContentType, 300, 300);
            var buffer = new byte[resized.Size];
            await resized.OpenReadStream().ReadAsync(buffer);
            profilePicture = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private async Task LoadUserData()
    {
        string currentUser = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "currentUser");
        if (string.IsNullOrEmpty(currentUser)) { Nav.NavigateTo("/login"); return; }

        if (File.Exists(filePath))
        {
            var json = await File.ReadAllTextAsync(filePath);
            var users = JsonSerializer.Deserialize<List<UserBL>>(json);
            var myUser = users?.FirstOrDefault(u => u.username == currentUser);

            if (myUser != null)
            {
                username = myUser.username ?? ""; email = myUser.email ?? ""; password = myUser.password ?? "";
                firstName = myUser.firstName ?? ""; lastName = myUser.lastName ?? ""; role = myUser.role ?? "Member";
                phone = myUser.phoneNumber ?? ""; address = myUser.address ?? ""; city = myUser.city ?? "";
                zipCode = myUser.zipCode ?? ""; profilePicture = myUser.profilePicture ?? "";
            }
        }
    }

    private async Task LoadNotifications()
    {
        userNotifications.Clear();

        string userIdStr = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "userId");
        if (int.TryParse(userIdStr, out int userId))
        {
            var activeSale = LiveSaleService.GetActiveSale();
            if (activeSale != null && activeSale.fs_items != null)
            {
                var node = activeSale.fs_items.head;
                while (node != null)
                {
                    var product = node.Data;
                    if (LiveSaleService.GetUserStatus(userId, product.product_id) == "Allocated")
                    {
                        userNotifications.Add(new NotificationBL
                            {
                                Message = $"Congratulations! You've been allocated a {product.name}. Checkout now to claim it!",
                                ProductId = product.product_id,
                                ExpiryTime = DateTime.Now.AddMinutes(2)
                            });
                    }
                    node = node.Next;
                }
            }
        }
    }

    private async Task SaveChanges()
    {
        List<UserBL> users = new();
        if (File.Exists(filePath))
        {
            var json = await File.ReadAllTextAsync(filePath);
            users = JsonSerializer.Deserialize<List<UserBL>>(json) ?? new List<UserBL>();
        }

        var existing = users.FirstOrDefault(u => u.username == username);
        if (existing != null)
        {
            existing.email = email; existing.password = password; existing.firstName = firstName; existing.lastName = lastName;
            existing.phoneNumber = phone; existing.address = address; existing.city = city; existing.zipCode = zipCode; existing.profilePicture = profilePicture;
        }

        await File.WriteAllTextAsync(filePath, JsonSerializer.Serialize(users, new JsonSerializerOptions { WriteIndented = true }));
        isSaved = true; await Task.Delay(1000); isSaved = false; isEditing = false;
    }

    private async Task Logout()
    {
        await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "currentUser");
        await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", "userRole");
        Nav.NavigateTo("/", forceLoad: true);
    }

    private async Task ProceedToFlashCheckout(int productId)
    {
        var product = CatalogService.MasterProductList.FirstOrDefault(p => p.product_id == productId);

        await CartService.AddToCart(product, 1);

        Nav.NavigateTo("/checkout");
    }

    public class NotificationBL
    {
        public string Message { get; set; }
        public int ProductId { get; set; }
        public DateTime ExpiryTime { get; set; }
    }
}