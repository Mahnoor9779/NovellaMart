@page "/signup"
@using System.IO
@using System.Text.Json
@using NovellaMart.Core.BL.Model_Classes
@rendermode RenderMode.InteractiveServer
@inject NavigationManager Nav

<PageTitle>Sign Up - NovellaMart</PageTitle>

<div class="signup-page-wrapper">
    <div class="back-arrow-container">
        <button class="btn-back-home" @onclick='() => Nav.NavigateTo("/")' title="Back to Home">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <div class="signup-card">
        <h2 class="signup-title">Sign up</h2>
        <div class="form-content">
            <div class="form-group-flat">
                <input type="text" class="form-input-flat @(string.IsNullOrEmpty(usernameError) ? "" : "invalid")"
                       placeholder="Username" @bind="username" autocomplete="off" />
                @if (!string.IsNullOrEmpty(usernameError))
                {
                    <span class="validation-message">@usernameError</span>
                }
            </div>

            <div class="form-group-flat">
                <input type="email" class="form-input-flat @(string.IsNullOrEmpty(emailError) ? "" : "invalid")"
                       placeholder="Email" @bind="email" autocomplete="off" />
                @if (!string.IsNullOrEmpty(emailError))
                {
                    <span class="validation-message">@emailError</span>
                }
            </div>

            <div class="form-group-flat">
                <input type="password" class="form-input-flat @(string.IsNullOrEmpty(passwordError) ? "" : "invalid")"
                       placeholder="Password" @bind="password" autocomplete="new-password" />
                @if (!string.IsNullOrEmpty(passwordError))
                {
                    <span class="validation-message">@passwordError</span>
                }
            </div>

            <button class="btn-signup-flat" @onclick="AttemptSignup">Sign up</button>
        </div>
        <div class="login-link">
            Already have an account? <a href="/login">Login</a>
        </div>
    </div>
</div>

@code {
    private string username = "", email = "", password = "";
    private string usernameError = "", emailError = "", passwordError = "";
    private string filePath = "Core/DL/users.json";

    private async Task AttemptSignup()
    {
        usernameError = ""; emailError = ""; passwordError = "";
        bool isValid = true;

        if (string.IsNullOrWhiteSpace(username)) { usernameError = "Required"; isValid = false; }
        if (string.IsNullOrWhiteSpace(email) || !email.Contains("@")) { emailError = "Invalid Email"; isValid = false; }
        if (string.IsNullOrWhiteSpace(password) || password.Length < 6) { passwordError = "Min 6 chars"; isValid = false; }

        if (isValid)
        {
            List<UserBL> users = File.Exists(filePath)
                ? JsonSerializer.Deserialize<List<UserBL>>(await File.ReadAllTextAsync(filePath)) ?? new()
                : new();

            if (users.Any(u => u.username == username)) { usernameError = "User exists"; return; }

            users.Add(new UserBL { username = username, email = email, password = password, role = "Member", isActive = true });
            await File.WriteAllTextAsync(filePath, JsonSerializer.Serialize(users, new JsonSerializerOptions { WriteIndented = true }));
            Nav.NavigateTo("/");
        }
    }
}