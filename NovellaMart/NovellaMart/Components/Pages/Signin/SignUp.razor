@page "/signup"
@using System.IO
@using System.Text.Json
@using NovellaMart
@using NovellaMart.Core.BL.Model_Classes
@rendermode RenderMode.InteractiveServer
@inject NavigationManager Nav

<PageTitle>Sign Up - NovellaMart</PageTitle>

<div class="signup-page-wrapper">
    <div class="signup-card">
        <h2 class="signup-title">Sign up</h2>

        <div class="form-content">
            <div class="form-group-flat">
                @* 👇 Added autocomplete="off" *@
                <input type="text" class="form-input-flat" placeholder="Username"
                       @bind="username" autocomplete="off" />
                @if (!string.IsNullOrEmpty(usernameError))
                {
                    <span class="validation-message">@usernameError</span>
                }
            </div>

            <div class="form-group-flat">
                @* 👇 Added autocomplete="off" *@
                <input type="email" class="form-input-flat" placeholder="Email"
                       @bind="email" autocomplete="off" />
                @if (!string.IsNullOrEmpty(emailError))
                {
                    <span class="validation-message">@emailError</span>
                }
            </div>

            <div class="form-group-flat">
                @* 👇 Added autocomplete="new-password" (This stops password autofill) *@
                <input type="password" class="form-input-flat" placeholder="Password"
                       @bind="password" autocomplete="new-password" />
                @if (!string.IsNullOrEmpty(passwordError))
                {
                    <span class="validation-message">@passwordError</span>
                }
            </div>

            <button class="btn-signup-flat" @onclick="AttemptSignup">Sign up</button>
        </div>

        <div class="login-link">
            Already have an account? <a href="/login">Login</a>
        </div>
    </div>
</div>

@code {
    private string username = "";
    private string email = "";
    private string password = "";
    private string usernameError = "";
    private string emailError = "";
    private string passwordError = "";

    private string filePath = "wwwroot/Files/users.json";

    private async Task AttemptSignup()
    {
        usernameError = ""; emailError = ""; passwordError = "";
        bool isValid = true;

        if (string.IsNullOrWhiteSpace(username)) { usernameError = "Required"; isValid = false; }
        if (string.IsNullOrWhiteSpace(email)) { emailError = "Required"; isValid = false; }
        else if (!email.Contains("@") || !email.Contains(".")) { emailError = "Invalid Email"; isValid = false; }
        if (string.IsNullOrWhiteSpace(password) || password.Length < 6) { passwordError = "Min 6 chars"; isValid = false; }

        if (isValid)
        {
            List<UserBL> users = new();

            if (File.Exists(filePath))
            {
                var json = await File.ReadAllTextAsync(filePath);
                users = JsonSerializer.Deserialize<List<UserBL>>(json) ?? new List<UserBL>();
            }

            if (users.Any(u => u.username == username))
            {
                usernameError = "User already exists";
                return;
            }

            // Using the new Constructor we added to UserBL
            UserBL newUser = new UserBL
            {
                username = username,
                email = email,
                password = password,
                role = "Member",
                isActive = true
            };

            users.Add(newUser);

            var newJson = JsonSerializer.Serialize(users, new JsonSerializerOptions { WriteIndented = true });
            await File.WriteAllTextAsync(filePath, newJson);

            await Task.Delay(100);
            Nav.NavigateTo("/login");
        }
    }
}