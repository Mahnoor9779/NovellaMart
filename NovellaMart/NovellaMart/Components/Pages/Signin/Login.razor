@page "/login"
@using System.IO
@using System.Text.Json
@using NovellaMart.Core.BL.Model_Classes
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@inject NovellaMart.Core.BL.Services.AuthStateService AuthState
@rendermode RenderMode.InteractiveServer

<PageTitle>Login - NovellaMart</PageTitle>

<div class="signup-page-wrapper">
    <div class="back-arrow-container">
        <button class="btn-back-home" @onclick='() => Nav.NavigateTo("/")' title="Back to Home">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <div class="signup-card">
        <h2 class="signup-title">Login</h2>
        <div class="form-content">
            <div class="form-group-flat">
                <input type="text" class="form-input-flat" placeholder="Username"
                       @bind="username" autocomplete="off" />
            </div>
            <div class="form-group-flat">
                <input type="password" class="form-input-flat" placeholder="Password"
                       @bind="password" autocomplete="new-password" />
            </div>

            @if (!string.IsNullOrEmpty(loginError))
            {
                <div class="validation-message">@loginError</div>
            }

            <button class="btn-signup-flat" @onclick="AttemptLogin">Login</button>
        </div>
        <div class="login-link">
            Don't have an account? <a href="/signup">Sign up</a>
        </div>
    </div>
</div>

@code {
    private string username = "", password = "", loginError = "";
    private string filePath = "Core/DL/users.json";

    private async Task AttemptLogin()
    {
        loginError = "";
        if (!File.Exists(filePath)) { loginError = "No users found."; return; }

        var json = await File.ReadAllTextAsync(filePath);
        var users = JsonSerializer.Deserialize<List<UserBL>>(json);
        var user = users?.FirstOrDefault(u => u.username == username && u.password == password);

        if (user != null)
        {
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "currentUser", user.username);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "userRole", user.role);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "userId", user.user_id.ToString());

            if (user.role == "Admin")
                Nav.NavigateTo("/admin", forceLoad: true);
            else
                Nav.NavigateTo("/", forceLoad: true);
        }
        else { loginError = "Invalid Credentials"; }
    }
}