@page "/"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject NovellaMart.Core.BL.Services.ProductCatalogService CatalogService
@inject NovellaMart.Core.BL.Services.CartService CartService
@using NovellaMart.Core.BL.Data_Structures
@using NovellaMart.Core.BL.Model_Classes

<PageTitle>Home - NovellaMart</PageTitle>

<div class="home-container">

    <section class="hero-section">
        <div class="hero-content">
            <span class="hero-subtitle">UP TO 30% OFF NEW ARRIVALS</span>
            <h1 class="hero-title">Find Your Sparkle. <br /> Own Your Style.</h1>
            <p class="hero-text">Discover the latest trends in women's fashion and accessories.</p>

            <a href="shop" class="btn btn-primary btn-lg hero-btn">SHOP NOW</a>
        </div>
    </section>

    <section class="section-pad categories-section">
        <div class="text-center mb-5">
            <h3 class="section-title d-inline-block">Shop By Category</h3>
        </div>

        <div class="categories-grid">
            <a href="shop/Skincare" class="cat-circle-item">
                <img src="https://via.placeholder.com/300x300/f17fb2/ffffff?text=Skincare" class="cat-img">
                <div class="cat-overlay"><span class="cat-name">Skincare</span></div>
            </a>
            <a href="shop/Cosmetics" class="cat-circle-item">
                <img src="https://via.placeholder.com/300x300/5ff4ef/ffffff?text=Makeup" class="cat-img">
                <div class="cat-overlay"><span class="cat-name">Makeup</span></div>
            </a>
            <a href="shop/Woman Wear" class="cat-circle-item">
                <img src="https://via.placeholder.com/300x300/f1ee56/333333?text=Wear" class="cat-img">
                <div class="cat-overlay"><span class="cat-name">Woman Wear</span></div>
            </a>
            <a href="shop/Accessories" class="cat-circle-item">
                <img src="https://via.placeholder.com/300x300/D4AF37/ffffff?text=Accessories" class="cat-img">
                <div class="cat-overlay"><span class="cat-name">Accessories</span></div>
            </a>
        </div>
    </section>

    <section class="section-pad trending-section bg-light">
        <div class="container">
            <div class="position-relative text-center mb-5">
                <h3 class="section-title d-inline-block mb-0">Trending Now</h3>
                <a href="shop" class="btn-link-pink position-absolute end-0 top-50 translate-middle-y d-none d-md-block">
                    View All <i class="fas fa-arrow-right ms-1"></i>
                </a>
            </div>

            <div class="product-grid-4">
                @if (TrendingList != null && !TrendingList.IsEmpty())
                {
                    var currentNode = TrendingList.head;
                    while (currentNode != null)
                    {
                        var p = currentNode.Data;
                        bool isAdded = addedStates.ContainsKey(p.product_id) && addedStates[p.product_id];

                        <div class="product-card">
                            <div class="product-img-wrapper">
                                <img src="@(p.images != null && p.images.Length > 0 ? p.images[0] : "https://via.placeholder.com/300?text=No+Image")"
                                     alt="@p.name" class="product-img">
                            </div>

                            <div class="product-info">
                                <div class="p-cat">@p.category.name</div>
                                <a href="product/@p.product_id" class="p-name">@p.name</a>
                                <div class="p-price">Rs. @p.price.ToString("N0")</div>

                                <button class="btn-add-to-cart @(isAdded ? "btn-success" : "")"
                                        @onclick="() => AddToCart(p)"
                                        disabled="@isAdded">
                                    @if (isAdded)
                                    {
                                        <span><i class="fas fa-check me-2"></i> Added</span>
                                    }
                                    else
                                    {
                                        <span>ADD TO CART</span>
                                    }
                                </button>
                            </div>
                        </div>
                        currentNode = currentNode.Next;
                    }
                }
                else
                {
                    <p class="text-center w-100 py-5">Loading trending styles...</p>
                }
            </div>

            <div class="text-center d-md-none mt-4">
                <a href="shop" class="btn btn-outline-dark rounded-pill px-4">View All Products</a>
            </div>
        </div>
    </section>
</div>

@code {
    private MyLinkedList<ProductBL> TrendingList = new MyLinkedList<ProductBL>();
    private Dictionary<int, bool> addedStates = new Dictionary<int, bool>();

    protected override async Task OnInitializedAsync()
    {
        await CatalogService.LoadProductsAsync();

        TrendingList.Clear();
        var node = CatalogService.MasterProductList.head;
        int count = 0;

        while (node != null && count < 4)
        {
            var p = node.Data;
            if (p.tags.FindNode("Trending"))
            {
                TrendingList.InsertAtEnd(p);
                count++;
            }
            node = node.Next;
        }
    }

    private async Task AddToCart(ProductBL product)
    {
        await CartService.AddToCart(product, 1);

        if (addedStates.ContainsKey(product.product_id)) addedStates[product.product_id] = true;
        else addedStates.Add(product.product_id, true);

        StateHasChanged();

        await Task.Delay(2000);
        addedStates[product.product_id] = false;
        StateHasChanged();
    }
}