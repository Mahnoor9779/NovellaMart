@page "/product/{ProductId:int}"
@rendermode InteractiveServer

@using NovellaMart.Core.BL.Model_Classes
@using NovellaMart.Core.BL.Services
@inject ProductService ProductService
@inject CartService CartService
@inject NavigationManager NavManager

@if (product == null)
{
    <p class="loading-text">Loading product...</p>
}
else
{
    <div class="product-details-wrapper">

        <!-- LEFT: Image Gallery -->
        <div class="product-images-panel">
            <div class="product-image-frame">
                @if (product.images.Length > 0)
                {
                    <img src="@product.images[selectedImage]" alt="@product.name" />
                }
            </div>

            <div class="thumbnail-row">
                @for (int i = 0; i < product.images.Length; i++)
                {
                    int localIndex = i;
                    <img src="@product.images[i]"
                         class="thumbnail @(i == selectedImage ? "active-thumb" : "")"
                         @onclick="() => selectedImage = localIndex" />
                }
            </div>
        </div>

        <!-- RIGHT: Product Info -->
        <div class="product-info-card">
            <h1 class="product-title">@product.name</h1>

            <span class="product-category">@product.category?.name</span>

            <p class="product-desc">@product.description</p>

            <div class="price-stock">
                <span class="price">Rs. @product.price</span>
                <span class="stock @(product.stock > 0 ? "in-stock" : "out-stock")">
                    @(product.stock > 0 ? "In Stock" : "Out of Stock")
                </span>
            </div>

            <div class="quantity-selector">
                <button @onclick="() => ChangeQty(-1)">-</button>
                <span>@quantity</span>
                <button @onclick="() => ChangeQty(1)">+</button>
            </div>

            <!-- Updated Add to Cart Button with UX Feedback -->
            <button class="btn-add-cart @(isAdded ? "btn-success-anim" : "")"
                    @onclick="AddToCart"
                    disabled="@(product.stock == 0 || isAdded)">
                @if (isAdded)
                {
                    <span><i class="fas fa-check-circle"></i> Added Successfully</span>
                }
                else
                {
                    <span><i class="fas fa-shopping-cart"></i> Add to Cart</span>
                }
            </button>

            <button class="btn-buy-now" @onclick="BuyNow">
                Buy Now
            </button>
        </div>
    </div>
}

<style>
    /* Local style for the success animation */
    .btn-success-anim {
        background-color: #28a745 !important; /* Green */
        color: white !important;
        border-color: #28a745 !important;
        transition: all 0.3s ease;
        transform: scale(1.02);
    }
</style>

@code {
    [Parameter]
    public int ProductId { get; set; }

    private ProductBL product;
    private int selectedImage = 0;
    private int quantity = 1;
    private bool isAdded = false;

    protected override void OnInitialized()
    {
        product = ProductService.GetProductById(ProductId);
    }

    private void ChangeQty(int value)
    {
        if (quantity + value > 0)
            quantity += value;
    }

    private async Task AddToCart()
    {
        // 1. Add to Cart Logic
        await CartService.AddToCart(product, quantity);

        // 2. Trigger UI Feedback
        isAdded = true;
        StateHasChanged();

        // 3. Revert after 2 seconds
        await Task.Delay(2000);
        isAdded = false;
        StateHasChanged();
    }

    private async Task BuyNow()
    {
        await CartService.AddToCart(product, quantity);
        NavManager.NavigateTo("/cart");
    }
}