@page "/product/{ProductId:int}"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Model_Classes
@using NovellaMart.Core.BL.Services
@inject NovellaMart.Core.BL.Services.ProductCatalogService CatalogService
@inject NovellaMart.Core.BL.Services.CartService CartService
@inject NavigationManager NavManager

<PageTitle>@(_product?.name ?? "Product Details") - NovellaMart</PageTitle>

@if (_isLoading)
{
    <div class="loading-container">
        <div class="spinner-border text-pink" role="status"></div>
        <p>Loading...</p>
    </div>
}
else if (_product == null)
{
    <div class="not-found-container">
        <h3>Product Not Found</h3>
        <a href="/shop" class="btn-theme mt-3">Back to Shop</a>
    </div>
}
else
{
    <div class="container my-5">
        <div class="product-grid-layout fade-in">

            <div class="card-panel image-panel">
                <div class="main-image-frame">
                    @if (_product.images != null && _product.images.Length > 0)
                    {
                        <img src="@_product.images[_selectedImageIndex]" alt="@_product.name" class="main-product-img" />
                    }
                </div>

                @if (_product.images != null && _product.images.Length > 1)
                {
                    <div class="thumbnail-row">
                        @for (int i = 0; i < _product.images.Length; i++)
                        {
                            int localIndex = i;
                            <img src="@_product.images[i]"
                                 class="thumbnail @(i == _selectedImageIndex ? "active" : "")"
                                 @onclick="() => _selectedImageIndex = localIndex" />
                        }
                    </div>
                }
            </div>

            <div class="card-panel info-panel">
                <div class="info-header">
                    <span class="category-tag">@_product.category?.name</span>
                    <h1 class="product-title">@_product.name</h1>
                </div>

                <div class="price-row">
                    <span class="price-tag">PKR @_product.price.ToString("N0")</span>
                    @if (_product.stock > 0)
                    {
                        <span class="stock-badge in-stock"><i class="fas fa-check-circle"></i> In Stock</span>
                    }
                    else
                    {
                        <span class="stock-badge out-stock"><i class="fas fa-times-circle"></i> Out of Stock</span>
                    }
                </div>

                <p class="description-text">@_product.description</p>

                <div class="controls-area">
                    <div class="quantity-box">
                        <button @onclick="() => ChangeQty(-1)" disabled="@(_quantity <= 1)">-</button>
                        <span>@_quantity</span>
                        <button @onclick="() => ChangeQty(1)" disabled="@(_quantity >= _product.stock)">+</button>
                    </div>

                    <div class="action-buttons">
                        @if (_showUndo)
                        {
                            <button class="btn-action btn-undo" @onclick="UndoAdd">
                                <i class="fas fa-undo"></i> Undo
                            </button>
                        }
                        else
                        {
                            <button class="btn-action btn-add" @onclick="AddToCart" disabled="@(_product.stock == 0 || _isAdded)">
                                @if (_isAdded)
                                {
                                    <span><i class="fas fa-check"></i> Added</span>
                                }
                                else
                                {

                                    <span><i class="fas fa-shopping-bag"></i> Add to Cart</span>
                                }
                            </button>
                        }

                        <button class="btn-action btn-buy" @onclick="BuyNow" disabled="@(_product.stock == 0)">
                            Buy Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int ProductId { get; set; }
    private ProductBL? _product;
    private int _selectedImageIndex = 0;
    private int _quantity = 1;
    private bool _isAdded = false;
    private bool _showUndo = false;
    private bool _isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;
        try
        {
            await CatalogService.LoadProductsAsync();
            _product = CatalogService.FindProductById(ProductId);
            if (_product != null) { CheckUndoState(); ResetLocalState(); }
        }
        finally { _isLoading = false; }
    }

    private void ResetLocalState() { _selectedImageIndex = 0; _quantity = 1; _isAdded = false; }

    private void CheckUndoState()
    {
        if (_product != null && CartService.CanUndo())
        {
            var lastAction = CartService.PeekLastAction();
            if (lastAction != null && lastAction.Type == "Add" && lastAction.ProductId == _product.product_id) _showUndo = true;
        }
    }

    private void ChangeQty(int value) { if (_quantity + value > 0) _quantity += value; }

    private async Task AddToCart()
    {
        if (_product == null) return;
        await CartService.AddToCart(_product, _quantity);
        _showUndo = true; _isAdded = true; StateHasChanged();
        await Task.Delay(3500);
        _showUndo = false; _isAdded = false; StateHasChanged();
    }

    private void UndoAdd() { CartService.UndoLastAction(); _showUndo = false; _isAdded = false; StateHasChanged(); }

    private async Task BuyNow()
    {
        if (_product == null) return;
        await CartService.AddToCart(_product, _quantity);
        NavManager.NavigateTo("/cart");
    }
}