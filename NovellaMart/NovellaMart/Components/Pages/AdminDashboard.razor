@page "/admin"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Services
@using NovellaMart.Core.BL.Model_Classes
@inject ProductCatalogService ProductService
@inject OrderService OrderService
@inject PromoCodeService PromoService
@inject NavigationManager Nav

<PageTitle>Admin Dashboard</PageTitle>

<div class="admin-sidebar-left @(isSidebarOpen ? "open" : "")">
    <div class="sidebar-header">
        <h3 class="sidebar-logo">NovellaMart</h3>
        <button class="btn-close-sidebar" @onclick="ToggleSidebar">√ó</button>
    </div>
    <div class="sidebar-links">
        <div class="menu-section">Sales Management</div>
        <a href="/flash-sale" class="sidebar-link"><i class="fas fa-bolt"></i> Flash Sale Dashboard</a>
        <a href="/admin/flash-sale-allocation" class="sidebar-link"><i class="fas fa-tasks"></i> Allocation Manager</a>
        <a href="/flash-sales" class="sidebar-link"><i class="fas fa-edit"></i> Create/Edit Sales</a>
        <a href="/admin/flash-sale-stats" class="sidebar-link"><i class="fas fa-chart-line"></i> Sale Statistics</a>

        <div class="menu-section mt-4">General</div>
        <a href="/admin-orders" class="sidebar-link"><i class="fas fa-shopping-cart"></i> All Orders</a>
        <a href="/profile" class="sidebar-link"><i class="fas fa-user-circle"></i> My Profile</a>
    </div>
</div>

@if (isSidebarOpen)
{
    <div class="sidebar-overlay" @onclick="ToggleSidebar"></div>
}

<div class="container my-5">
    <div class="page-title d-flex align-items-center gap-3">
        <button class="btn-sidebar-toggle" @onclick="ToggleSidebar">
            <i class="fas fa-bars"></i>
        </button>
        <div>
            <h1 class="mb-0">Admin Dashboard</h1>
            <div class="title-underline" style="margin: 5px 0;"></div>
            <p class="title-subtext mb-0">Overview of store performance & settings</p>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-box" style="background: #fff5fa; color: #ec4899;">üí∞</div>
                <div>
                    <h5 class="text-muted mb-1">Total Revenue</h5>
                    <h3 class="fw-bold mb-0">PKR @TotalRevenue.ToString("N0")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-box" style="background: #fff9c4; color: #fbc02d;">üõçÔ∏è</div>
                <div>
                    <h5 class="text-muted mb-1">Total Orders</h5>
                    <h3 class="fw-bold mb-0">@TotalOrders</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-box" style="background: #e0f7fa; color: #00bcd4;">üì¶</div>
                <div>
                    <h5 class="text-muted mb-1">Products</h5>
                    <h3 class="fw-bold mb-0">@TotalProducts</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-box" style="background: #f3e5f5; color: #ab47bc;">üë•</div>
                <div>
                    <h5 class="text-muted mb-1">Customers</h5>
                    <h3 class="fw-bold mb-0">324</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="summary-card h-100 p-4">
                <h3 style="margin-top:0; font-weight: 700; color: #333;">Recent Orders</h3>
                <p style="color: #888; font-size: 0.9rem; border-bottom: 2px dashed #eee; padding-bottom: 1rem;">Latest customer transactions.</p>

                <div class="table-responsive mt-3">
                    <table class="table" style="font-size: 0.9rem;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 1rem;">Order ID</th>
                                <th style="padding: 1rem;">Customer</th>
                                <th style="padding: 1rem;">Date</th>
                                <th style="padding: 1rem;">Amount</th>
                                <th style="padding: 1rem;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (RecentOrders != null && RecentOrders.Any())
                            {
                                @foreach (var order in RecentOrders)
                                {
                                    <tr>
                                        <td style="padding: 1rem; font-weight:600;">#@order.order_id</td>
                                        <td style="padding: 1rem;">@order.customer?.firstName @order.customer?.lastName</td>
                                        <td style="padding: 1rem;">@order.orderTime.ToShortDateString()</td>
                                        <td style="padding: 1rem; font-weight:600;">PKR @order.totalAmount.ToString("N0")</td>
                                        <td style="padding: 1rem;"><span class="badge rounded-pill @GetStatusClass(order.status)">@order.status</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">No recent orders found.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="summary-card h-100 p-4">
                <h3 style="margin-top:0; font-weight: 700; color: #333;">Promo Codes</h3>
                <p style="color: #888; font-size: 0.9rem; border-bottom: 2px dashed #eee; padding-bottom: 1rem;">Manage discounts.</p>

                <div class="mt-4">
                    <div class="d-flex gap-2 mb-4">
                        <input @bind="NewPromoCode" placeholder="Code" class="form-control" />
                        <input @bind="NewDiscount" type="number" placeholder="%" class="form-control" style="width: 80px;" />
                        <button class="btn btn-primary btn-add-promo" @onclick="CreatePromo">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="promo-list">
                        @if (PromoList != null && PromoList.Any())
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var promo in PromoList)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong style="color: #ec4899;">@promo.Code</strong>
                                            <span class="ms-2 badge bg-light text-dark border">@promo.DiscountPercentage% Off</span>
                                        </div>
                                        <button class="btn btn-sm text-danger" @onclick="() => DeletePromo(promo.Id)">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private bool isSidebarOpen = false;
    private void ToggleSidebar() => isSidebarOpen = !isSidebarOpen;

    private int TotalProducts = 0;
    private int TotalOrders = 0;
    private double TotalRevenue = 0;
    private List<OrderBL> RecentOrders = new();
    private List<PromoCodeBL> PromoList = new();
    private string NewPromoCode = "";
    private int NewDiscount = 0;

    protected override async Task OnInitializedAsync()
    {
        await ProductService.LoadProductsAsync();
        TotalProducts = ProductService.MasterProductList.Count();

        var ordersList = OrderService.GetAllOrders();
        TotalOrders = ordersList.Count();

        var current = ordersList.head;
        while (current != null)
        {
            TotalRevenue += current.Data.totalAmount;
            RecentOrders.Add(current.Data);
            current = current.Next;
        }

        RecentOrders.Reverse();
        RecentOrders = RecentOrders.Take(5).ToList();

        LoadPromos();
    }

    private void LoadPromos()
    {
        PromoList.Clear();
        var promos = PromoService.GetAllPromoCodes();
        var current = promos.head;
        while (current != null)
        {
            PromoList.Add(current.Data);
            current = current.Next;
        }
    }

    private void CreatePromo()
    {
        if (!string.IsNullOrWhiteSpace(NewPromoCode) && NewDiscount > 0)
        {
            PromoService.CreatePromoCode(NewPromoCode, NewDiscount);
            NewPromoCode = ""; NewDiscount = 0;
            LoadPromos();
        }
    }

    private void DeletePromo(int id)
    {
        PromoService.DeletePromoCode(id);
        LoadPromos();
    }

    private string GetStatusClass(string status) => status.ToLower() switch
    {
        "confirmed" => "bg-success-light text-success",
        _ => "bg-warning-light text-warning"
    };
}