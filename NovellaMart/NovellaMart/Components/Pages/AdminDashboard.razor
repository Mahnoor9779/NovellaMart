@page "/admin"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Services
@using NovellaMart.Core.BL.Model_Classes
@inject ProductCatalogService ProductService
@inject OrderService OrderService
@inject PromoCodeService PromoService

<PageTitle>Admin Dashboard</PageTitle>

<div class="container my-5">
    <!-- Header -->
    <div class="page-title">
        <h1>Admin Dashboard</h1>
        <div class="title-underline"></div>
        <p class="title-subtext">Overview of store performance & settings</p>
    </div>

    <!-- STATS GRID -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-box" style="background: #fff5fa; color: var(--nm-primary);">üí∞</div>
                <div>
                    <h5 class="text-muted mb-1">Total Revenue</h5>
                    <h3 class="fw-bold mb-0">PKR @TotalRevenue.ToString("N0")</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
             <div class="stat-card">
                <div class="icon-box" style="background: #fff9c4; color: #fbc02d;">üõçÔ∏è</div>
                <div>
                    <h5 class="text-muted mb-1">Total Orders</h5>
                    <h3 class="fw-bold mb-0">@TotalOrders</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
             <div class="stat-card">
                <div class="icon-box" style="background: #e0f7fa; color: var(--nm-accent);">üì¶</div>
                <div>
                    <h5 class="text-muted mb-1">Products</h5>
                    <h3 class="fw-bold mb-0">@TotalProducts</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
             <div class="stat-card">
                <div class="icon-box" style="background: #f3e5f5; color: #ab47bc;">üë•</div>
                <div>
                    <h5 class="text-muted mb-1">Customers</h5>
                    <h3 class="fw-bold mb-0">324</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- RECENT ORDERS -->
        <div class="col-lg-8">
            <div class="summary-card h-100">
                <h3 style="margin-top:0; font-weight: 700; color: #333;">Recent Orders</h3>
                 <p style="color: #888; font-size: 0.9rem; border-bottom: 2px dashed #eee; padding-bottom: 1rem;">Latest customer transactions.</p>
                
                <div class="table-responsive mt-3">
                    <table class="cart-table" style="font-size: 0.9rem;">
                        <thead>
                            <tr>
                                <th style="padding: 0.8rem;">Order ID</th>
                                <th style="padding: 0.8rem;">Customer</th>
                                <th style="padding: 0.8rem;">Date</th>
                                <th style="padding: 0.8rem;">Amount</th>
                                <th style="padding: 0.8rem;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (RecentOrders != null && RecentOrders.Any())
                            {
                                @foreach (var order in RecentOrders)
                                {
                                    <tr>
                                        <td style="padding: 0.8rem;">#@order.order_id</td>
                                        <td style="padding: 0.8rem;">@order.customer?.firstName @order.customer?.lastName</td>
                                        <td style="padding: 0.8rem;">@order.orderTime.ToShortDateString()</td>
                                        <td style="padding: 0.8rem;">PKR @order.totalAmount.ToString("N0")</td>
                                        <td style="padding: 0.8rem;"><span class="badge rounded-pill @GetStatusClass(order.status)">@order.status</span></td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">No recent orders found.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROMO CODE MANAGEMENT -->
        <div class="col-lg-4">
            <div class="summary-card h-100" style="border-top-color: var(--nm-primary);">
                <h3 style="margin-top:0; font-weight: 700; color: #333;">Promo Codes</h3>
                <p style="color: #888; font-size: 0.9rem; border-bottom: 2px dashed #eee; padding-bottom: 1rem;">Manage discounts.</p>

                <div class="mt-4">
                     <div class="d-flex gap-2 mb-4">
                        <input @bind="NewPromoCode" placeholder="Code (e.g. SAVE10)" class="form-control" />
                        <input @bind="NewDiscount" type="number" placeholder="%" class="form-control" style="width: 80px;" />
                        <button class="btn btn-primary" style="background: var(--nm-primary); border: none;" @onclick="CreatePromo">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>

                    <div class="promo-list">
                         @if (PromoList != null && PromoList.Any())
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var promo in PromoList)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong style="color: var(--nm-primary);">@promo.Code</strong>
                                            <span class="ms-2 badge bg-light text-dark border">@promo.DiscountPercentage% Off</span>
                                        </div>
                                        <button class="btn btn-sm text-danger" @onclick="() => DeletePromo(promo.Id)" title="Delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted text-center py-3">No active promo codes.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        transition: transform 0.2s;
        border: 1px solid rgba(0,0,0,0.02);
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .icon-box {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
    }

    .badge.confirmed { background-color: #e8f5e9; color: #2e7d32; }
    .badge.pending { background-color: #fff8e1; color: #fbc02d; }
    .badge.delivered { background-color: #e3f2fd; color: #1565c0; }
    
    .title-underline {
        width: 80px;
        height: 4px;
        background: var(--nm-secondary);
        margin: 10px auto;
        border-radius: 2px;
    }
    .title-subtext { color: #777; font-size: 1.1rem; }
</style>

@code {
    private int TotalProducts = 0;
    private int TotalOrders = 0;
    private double TotalRevenue = 0;
    private List<OrderBL> RecentOrders = new();
    
    // Promo Code Logic
    private List<PromoCodeBL> PromoList = new();
    private string NewPromoCode = "";
    private int NewDiscount = 0;

    protected override async Task OnInitializedAsync()
    {
        // Load Products
        await ProductService.LoadProductsAsync();
        TotalProducts = ProductService.MasterProductList.Count();

        // Load Orders
        var orders = OrderService.GetAllOrders();
        TotalOrders = orders.Count();

        // Calculate Revenue and Get Recent Orders
        var current = orders.head;
        while(current != null)
        {
            TotalRevenue += current.Data.totalAmount;
            RecentOrders.Add(current.Data);
            current = current.Next;
        }

        // Sort descending and take 5
        RecentOrders.Reverse(); 
        RecentOrders = RecentOrders.Take(5).ToList();
        
        LoadPromos();
    }
    
    private void LoadPromos()
    {
        PromoList.Clear();
        var promos = PromoService.GetAllPromoCodes();
        var current = promos.head;
        while(current != null)
        {
            PromoList.Add(current.Data);
            current = current.Next;
        }
    }

    private void CreatePromo()
    {
        if(!string.IsNullOrWhiteSpace(NewPromoCode) && NewDiscount > 0 && NewDiscount <= 100)
        {
            PromoService.CreatePromoCode(NewPromoCode, NewDiscount);
            NewPromoCode = "";
            NewDiscount = 0;
            LoadPromos();
        }
    }

    private void DeletePromo(int id)
    {
        PromoService.DeletePromoCode(id);
        LoadPromos();
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "confirmed" => "confirmed",
            "delivered" => "delivered",
            _ => "pending"
        };
    }
}
