@page "/shop/{Category?}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject NovellaMart.Core.BL.Services.ProductCatalogService CatalogService
@inject NovellaMart.Core.BL.Services.CartService CartService
@using NovellaMart.Core.BL.Data_Structures
@using NovellaMart.Core.BL.Model_Classes

<link href="css/shop-styles.css" rel="stylesheet" />

<div class="shop-container">
    <div class="page-header">
        <h1 class="page-title">@DisplayTitle</h1>
        <p class="text-muted mt-2">Explore our collection of @DisplayTitle</p>
    </div>

    <div class="shop-layout">
        <aside class="filters-sidebar">
            @if (CurrentSubCategories.Count() > 0)
            {
                <div class="filter-group">
                    <span class="filter-title">Sub Categories</span>
                    <button class="sub-cat-btn @(selectedSubCat == null ? "active" : "")"
                            @onclick="() => FilterBySubCat(null)">
                        All @Category
                    </button>

                    @foreach (var sub in CurrentSubCategories)
                    {
                        <button class="sub-cat-btn @(selectedSubCat == sub ? "active" : "")"
                                @onclick="() => FilterBySubCat(sub)">
                            @sub
                        </button>
                    }
                </div>
            }

            <div class="filter-group">
                <span class="filter-title">Price Range</span>
                <div class="d-flex gap-2 align-items-center mb-2">
                    <input type="number" @bind="minPrice" class="form-control" placeholder="Min" />
                    <span>-</span>
                    <input type="number" @bind="maxPrice" class="form-control" placeholder="Max" />
                </div>
                <button class="btn btn-dark w-100" @onclick="ApplyFilters">Apply</button>
            </div>

            <button class="btn btn-outline-danger w-100 btn-sm" @onclick="ResetFilters">Reset All</button>
        </aside>

        <main>
            <div class="d-flex justify-content-between mb-4 align-items-center">
                <span class="fw-bold">Showing @ResultCount Products</span>
                <select class="form-select w-auto shadow-sm border-0" @onchange="SortProducts">
                    <option value="default">Newest Arrivals</option>
                    <option value="low-high">Price: Low to High</option>
                    <option value="high-low">Price: High to Low</option>
                </select>
            </div>

            <div class="products-grid">
                @if (PagedProducts.Count() == 0)
                {
                    <div class="text-center w-100 py-5">
                        <h4>No products found.</h4>
                        <p class="text-muted">Try adjusting your filters.</p>
                    </div>
                }
                else
                {
                    var node = PagedProducts.head;
                    while (node != null)
                    {
                        var p = node.Data;
                        <div class="product-card">
                            <div class="img-wrapper">
                                <a href="product/@p.product_id" style="display:block; width:100%; height:100%;">
                                    <img src="@(p.images.Length > 0 ? p.images[0] : "https://via.placeholder.com/300")"
                                         alt="@p.name" class="product-img" />
                                </a>

                                <div class="product-actions">
                                    <a href="product/@p.product_id" class="btn-action" title="View Details">
                                        <i class="far fa-eye"></i>
                                    </a>
                                </div>
                            </div>

                            <div class="product-info">
                                <div class="p-cat">@(Category ?? p.category?.name)</div>

                                <a href="product/@p.product_id" class="p-name">@p.name</a>

                                <div class="p-price">PKR @p.price.ToString("N0")</div>

                                @if (IsUndoVisible(p.product_id))
                                {
                                    <button class="btn-add-to-cart btn-undo-state" @onclick="UndoAdd">
                                        <span><i class="fas fa-undo me-2"></i> Undo</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn-add-to-cart" @onclick="() => AddToCart(p)">
                                        <span><i class="fas fa-shopping-bag me-2"></i> Add To Cart</span>
                                    </button>
                                }
                            </div>
                        </div>
                        node = node.Next;
                    }
                }
            </div>

            @if (TotalPages > 1)
            {
                <div class="pagination">
                    <button class="page-btn" @onclick="() => ChangePage(currentPage - 1)" disabled="@(currentPage == 1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    @{
                        // Logic to show exactly 3 pages sliding window
                        int startPage = currentPage - 1;
                        int endPage = currentPage + 1;

                        if (startPage < 1)
                        {
                            startPage = 1;
                            endPage = Math.Min(3, TotalPages);
                        }

                        if (endPage > TotalPages)
                        {
                            endPage = TotalPages;
                            startPage = Math.Max(1, TotalPages - 2);
                        }
                    }

                    @if (startPage > 1)
                    {
                        <span class="dots mx-2" style="align-self:end; padding-bottom:5px;">...</span>
                    }

                    @for (int i = startPage; i <= endPage; i++)
                    {
                        int p = i;
                        <button class="page-btn @(currentPage == p ? "active" : "")"
                                @onclick="() => ChangePage(p)">
                            @p
                        </button>
                    }

                    @if (endPage < TotalPages)
                    {
                        <span class="dots mx-2" style="align-self:end; padding-bottom:5px;">...</span>
                    }

                    <button class="page-btn" @onclick="() => ChangePage(currentPage + 1)" disabled="@(currentPage == TotalPages)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            }

            @if (!RecentlyViewed.IsEmpty())
            {
                <div class="mt-5 pt-4 border-top">
                    <h4 class="section-title mb-4" style="font-size:1.5rem;">Recently Viewed</h4>
                    <div class="products-grid" style="grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));">
                        @for (int i = 0; i < RecentlyViewed.size; i++)
                        {
                            int idx = (RecentlyViewed.front + i) % RecentlyViewed.capacity;
                            var rv = RecentlyViewed.arr[idx];
                            if (rv != null)
                            {
                                <div class="product-card" style="border-top: none;">
                                    <div class="img-wrapper" style="height: 180px;">
                                        <img src="@(rv.images.Length > 0 ? rv.images[0] : "")" class="product-img" />
                                    </div>
                                    <div class="product-info p-2">
                                        <div class="p-name" style="font-size:0.85rem; height:auto;">@rv.name</div>
                                        <div class="p-price" style="font-size:0.9rem;">PKR @rv.price</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
        </main>
    </div>
</div>

@code {
    [Parameter] public string? Category { get; set; }

    // CUSTOM DATA STRUCTURES
    private MyLinkedList<ProductBL> FilteredList = new MyLinkedList<ProductBL>();
    private MyLinkedList<ProductBL> PagedProducts = new MyLinkedList<ProductBL>();
    private MyLinkedList<string> CurrentSubCategories = new MyLinkedList<string>();
    private MyLinkedList<int> undoVisibleIds = new MyLinkedList<int>();
    private CircularQueue<ProductBL> RecentlyViewed = new CircularQueue<ProductBL>(5);

    private string DisplayTitle => string.IsNullOrEmpty(Category) ? "All Products" : Category;
    private string? selectedSubCat;
    private double? minPrice;
    private double? maxPrice;
    private string sortOption = "default";

    private int ResultCount = 0;
    private int currentPage = 1;
    private int pageSize = 12;
    private int TotalPages = 1;

    private Dictionary<string, List<string>> SubCatMap = new()
    {
        { "Skincare", new() { "Cleansers", "Serums", "Moisturizers", "Sunscreen", "Masks" } },
        { "Cosmetics", new() { "Face", "Eyes", "Lips", "Nails", "Tools" } },
        { "Woman Wear", new() { "Dresses", "Tops", "Bottoms", "Outerwear", "Activewear" } },
        { "Accessories", new() { "Jewellery", "Watches", "Bags", "Eyewear", "Scarves" } }
    };

    protected override async Task OnParametersSetAsync()
    {
        await CatalogService.LoadProductsAsync();

        CurrentSubCategories.Clear();
        if (!string.IsNullOrEmpty(Category) && SubCatMap.ContainsKey(Category))
        {
            foreach (var sub in SubCatMap[Category])
            {
                CurrentSubCategories.InsertAtEnd(sub);
            }
        }

        ResetFilters();
    }

    private async Task AddToCart(ProductBL product)
    {
        RecentlyViewed.Enqueue(product);
        await CartService.AddToCart(product, 1);
        if (!undoVisibleIds.FindNode(product.product_id)) undoVisibleIds.InsertAtEnd(product.product_id);
        StateHasChanged();
        await Task.Delay(3500);
        undoVisibleIds.Remove(product.product_id);
        StateHasChanged();
    }

    private void ViewProduct(ProductBL product)
    {
        RecentlyViewed.Enqueue(product);
        Nav.NavigateTo($"product/{product.product_id}");
    }

    private bool IsUndoVisible(int id) => undoVisibleIds.FindNode(id) && CartService.CanUndo();

    private void UndoAdd()
    {
        var action = CartService.PeekLastAction();
        if (action != null) undoVisibleIds.Remove(action.ProductId);
        CartService.UndoLastAction();
        StateHasChanged();
    }

    private void FilterBySubCat(string? subCat)
    {
        selectedSubCat = (selectedSubCat == subCat) ? null : subCat;
        currentPage = 1;
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        FilteredList.Clear();

        MyLinkedList<ProductBL> candidateList = new MyLinkedList<ProductBL>();

        // 1. Fetch Candidates (O(N))
        var node = CatalogService.MasterProductList.head;
        while (node != null)
        {
            var p = node.Data;
            bool priceMatch = true;

            if (minPrice.HasValue && p.price < minPrice.Value) priceMatch = false;
            if (maxPrice.HasValue && p.price > maxPrice.Value) priceMatch = false;

            if (priceMatch) candidateList.InsertAtEnd(p);
            node = node.Next;
        }

        HeapPriorityQueue<ProductBL> sortQueue = new HeapPriorityQueue<ProductBL>(candidateList.Count() > 0 ? candidateList.Count() : 10);

        var cNode = candidateList.head;
        while (cNode != null)
        {
            var p = cNode.Data;
            bool isMatch = true;

            if (!string.IsNullOrEmpty(Category))
            {
                if (Category.Equals("Trending", StringComparison.OrdinalIgnoreCase))
                {
                    if (p.tags == null || !p.tags.FindNode("Trending")) isMatch = false;
                }
                else if (p.tags == null || !p.tags.FindNode(Category))
                {
                    isMatch = false;
                }
            }

            if (isMatch && selectedSubCat != null && (p.tags == null || !p.tags.FindNode(selectedSubCat))) isMatch = false;

            if (isMatch)
            {
                long priority = 0;

                if (sortOption == "high-low")
                    priority = (long)(-p.price * 100);
                else if (sortOption == "low-high")
                    priority = (long)(p.price * 100);
                else
                    priority = p.product_id;

                sortQueue.Enqueue(p, priority);
            }
            cNode = cNode.Next;
        }

        while (!sortQueue.IsEmpty())
        {
            FilteredList.InsertAtEnd(sortQueue.Dequeue());
        }

        ResultCount = FilteredList.Count();
        CalculatePagination();
    }

    private void CalculatePagination()
    {
        TotalPages = (int)Math.Ceiling((double)ResultCount / pageSize);
        if (TotalPages < 1) TotalPages = 1;
        if (currentPage > TotalPages) currentPage = 1;
        LoadCurrentPage();
    }

    private void LoadCurrentPage()
    {
        PagedProducts.Clear();
        var node = FilteredList.head;
        int skip = (currentPage - 1) * pageSize;
        int count = 0;
        int added = 0;

        while (node != null && added < pageSize)
        {
            if (count >= skip)
            {
                PagedProducts.InsertAtEnd(node.Data);
                added++;
            }
            count++;
            node = node.Next;
        }
        StateHasChanged();
    }

    private void ChangePage(int page)
    {
        if (page < 1 || page > TotalPages) return;
        currentPage = page;
        LoadCurrentPage();
    }

    private void SortProducts(ChangeEventArgs e) { sortOption = e.Value?.ToString() ?? "default"; ApplyFilters(); }

    private void ResetFilters()
    {
        selectedSubCat = null; minPrice = null; maxPrice = null; sortOption = "default"; currentPage = 1;
        ApplyFilters();
    }
}