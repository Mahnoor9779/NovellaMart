@page "/shop/{Category?}"
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject NovellaMart.Core.BL.Services.ProductCatalogService CatalogService
@inject NovellaMart.Core.BL.Services.CartService CartService
@using NovellaMart.Core.BL.Data_Structures
@using NovellaMart.Core.BL.Model_Classes

<link href="css/shop-styles.css" rel="stylesheet" />

<div class="shop-container">
    <div class="page-header">
        <h1 class="page-title">@DisplayTitle</h1>
        <p class="text-muted mt-2">Explore our collection of @DisplayTitle</p>
    </div>

    <div class="shop-layout">
        <aside class="filters-sidebar">
            @if (CurrentSubCategories.Count > 0)
            {
                <div class="filter-group">
                    <span class="filter-title">Sub Categories</span>
                    <button class="sub-cat-btn @(selectedSubCat == null ? "active" : "")"
                            @onclick="() => FilterBySubCat(null)">
                        All @Category
                    </button>

                    @foreach (var sub in CurrentSubCategories)
                    {
                        <button class="sub-cat-btn @(selectedSubCat == sub ? "active" : "")"
                                @onclick="() => FilterBySubCat(sub)">
                            @sub
                        </button>
                    }
                </div>
            }

            <div class="filter-group">
                <span class="filter-title">Price Range</span>
                <div class="d-flex gap-2 align-items-center mb-2">
                    <input type="number" @bind="minPrice" class="form-control" placeholder="Min" />
                    <span>-</span>
                    <input type="number" @bind="maxPrice" class="form-control" placeholder="Max" />
                </div>
                <button class="btn btn-dark w-100" @onclick="ApplyFilters">Apply</button>
            </div>

            <div class="filter-group">
                <span class="filter-title">Colors</span>
                <div class="color-options">
                    @foreach (var color in AllColors)
                    {
                        <div class="color-circle @(selectedColor == color ? "selected" : "")"
                             style="background-color: @color;" @onclick="() => FilterByColor(color)"></div>
                    }
                </div>
            </div>

            <button class="btn btn-outline-danger w-100 btn-sm" @onclick="ResetFilters">Reset All</button>
        </aside>

        <main>
            <div class="d-flex justify-content-between mb-4 align-items-center">
                <span class="fw-bold">Showing @ResultCount Products</span>
                <select class="form-select w-auto shadow-sm border-0" @onchange="SortProducts">
                    <option value="default">Newest Arrivals</option>
                    <option value="low-high">Price: Low to High</option>
                    <option value="high-low">Price: High to Low</option>
                </select>
            </div>

            <div class="products-grid">
                @if (PagedProducts.Count() == 0)
                {
                    <div class="text-center w-100 py-5">
                        <h4>No products found.</h4>
                        <p class="text-muted">Try adjusting your filters.</p>
                    </div>
                }
                else
                {
                    var node = PagedProducts.head;
                    while (node != null)
                    {
                        var p = node.Data;
                        bool isAdded = addedStates.ContainsKey(p.product_id) && addedStates[p.product_id];

                        <div class="product-card">
                            <!-- Image Section -->
                            <div class="img-wrapper">
                                <img src="@(p.images.Length > 0 ? p.images[0] : "")" alt="@p.name" class="product-img" />

                                <div class="product-actions">
                                    <a href="product/@p.product_id" class="btn-action" title="View Details">
                                        <i class="far fa-eye"></i>
                                    </a>
                                    <button class="btn-action" title="Add to Wishlist">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Content Section -->
                            <div class="product-info">
                                <div class="p-cat">@p.category.name</div>
                                <a href="product/@p.product_id" class="p-name">@p.name</a>
                                <div class="p-price">PKR @p.price.ToString("N0")</div>

                                <!-- FIXED: Button is explicitly here in the flow, not hidden in image -->
                                <!-- FIXED: Button with Undo Logic -->
                                @if (CanUndo(p.product_id))
                                {
                                    <button class="btn-add-to-cart btn-undo-state" @onclick="UndoAdd">
                                        <span><i class="fas fa-undo me-2"></i> Undo</span>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn-add-to-cart" @onclick="() => AddToCart(p)">
                                        <span><i class="fas fa-shopping-bag me-2"></i> Add To Cart</span>
                                    </button>
                                }
                            </div>
                        </div>
                        node = node.Next;
                    }
                }
            </div>

            @if (TotalPages > 1)
            {
                <div class="pagination">
                    @for (int i = 1; i <= TotalPages; i++)
                    {
                        int pageNum = i;
                        <button class="page-btn @(currentPage == pageNum ? "active" : "")"
                                @onclick="() => ChangePage(pageNum)">
                            @pageNum
                        </button>
                    }
                </div>
            }
        </main>
    </div>
</div>

@code {
    [Parameter] public string? Category { get; set; }

    private MyLinkedList<ProductBL> FilteredList = new MyLinkedList<ProductBL>();
    private MyLinkedList<ProductBL> PagedProducts = new MyLinkedList<ProductBL>();
    private Dictionary<int, bool> addedStates = new Dictionary<int, bool>();

    private string DisplayTitle => string.IsNullOrEmpty(Category) ? "All Products" : Category;
    private List<string> CurrentSubCategories = new();

    private string? selectedSubCat;
    private double? minPrice;
    private double? maxPrice;
    private string? selectedColor;
    private string sortOption = "default";

    private int ResultCount = 0;
    private int currentPage = 1;
    private int pageSize = 12;
    private int TotalPages = 1;

    private List<string> AllColors = new() { "#ffffff", "#000000", "#f17fb2", "#ff0000", "#0000ff", "#ffd700", "#8b4513", "#f5deb3", "#ff69b4" };

    private Dictionary<string, List<string>> SubCatMap = new()
    {
        { "Skincare", new() { "Cleansers", "Serums", "Moisturizers", "Sunscreen", "Masks" } },
        { "Cosmetics", new() { "Face", "Eyes", "Lips", "Nails", "Tools" } },
        { "Woman Wear", new() { "Dresses", "Tops", "Bottoms", "Outerwear", "Activewear" } },
        { "Accessories", new() { "Jewellery", "Watches", "Bags", "Eyewear", "Scarves" } }
    };

    protected override async Task OnParametersSetAsync()
    {
        await CatalogService.LoadProductsAsync();

        if (!string.IsNullOrEmpty(Category) && SubCatMap.ContainsKey(Category))
            CurrentSubCategories = SubCatMap[Category];
        else
            CurrentSubCategories = new List<string>();

        ResetFilters();
    }

    private HashSet<int> undoVisible = new HashSet<int>();

    private bool CanUndo(int productId)
    {
        return undoVisible.Contains(productId) &&
               CartService.CanUndo() && 
               CartService.PeekLastAction().Type == "Add" && 
               CartService.PeekLastAction().ProductId == productId;
    }

    private async Task AddToCart(ProductBL product)
    {
        await CartService.AddToCart(product, 1);
        undoVisible.Add(product.product_id);
        StateHasChanged();

        await Task.Delay(3500);
        
        undoVisible.Remove(product.product_id);
        StateHasChanged();
    }

    private void UndoAdd()
    {
        var action = CartService.PeekLastAction();
        if(action != null)
        {
             undoVisible.Remove(action.ProductId);
        }
        CartService.UndoLastAction();
        StateHasChanged();
    }

    private void ApplyFilters()
    {
        List<ProductBL> candidateList = new List<ProductBL>();
        if (CatalogService.PriceTree.Root != null && (minPrice.HasValue || maxPrice.HasValue))
        {
            double min = minPrice ?? 0;
            double max = maxPrice ?? double.MaxValue;
            ProductBL pMin = new ProductBL { price = min, product_id = int.MinValue };
            ProductBL pMax = new ProductBL { price = max, product_id = int.MaxValue };
            CatalogService.PriceTree.GetRange(CatalogService.PriceTree.Root, pMin, pMax, candidateList, CatalogService.PriceComparator);
        }
        else
        {
            var node = CatalogService.MasterProductList.head;
            while (node != null) { candidateList.Add(node.Data); node = node.Next; }
        }

        List<ProductBL> refinedList = new List<ProductBL>();
        foreach (var p in candidateList)
        {
            bool isMatch = true;
            if (!string.IsNullOrEmpty(Category) && !p.tags.FindNode(Category)) isMatch = false;
            if (isMatch && selectedSubCat != null && !p.tags.FindNode(selectedSubCat)) isMatch = false;
            if (isMatch && selectedColor != null && !p.tags.FindNode(selectedColor)) isMatch = false;
            if (isMatch) refinedList.Add(p);
        }

        FilteredList.Clear();
        if (sortOption == "default") foreach (var item in refinedList) FilteredList.InsertAtEnd(item);
        else
        {
            PriorityQueue<ProductBL> pq = new PriorityQueue<ProductBL>();
            foreach (var item in refinedList)
            {
                int priority = (sortOption == "high-low") ? (int)item.price : -(int)item.price;
                pq.Enqueue(item, priority);
            }
            while (!pq.IsEmpty()) FilteredList.InsertAtEnd(pq.Dequeue());
        }
        ResultCount = FilteredList.Count();
        CalculatePagination();
    }

    private void CalculatePagination() { TotalPages = (int)Math.Ceiling((double)ResultCount / pageSize); if (TotalPages < 1) TotalPages = 1; currentPage = 1; LoadCurrentPage(); }
    private void LoadCurrentPage() { PagedProducts.Clear(); var node = FilteredList.head; int skip = (currentPage - 1) * pageSize; int count = 0; int added = 0; while (node != null && added < pageSize) { if (count >= skip) { PagedProducts.InsertAtEnd(node.Data); added++; } count++; node = node.Next; } StateHasChanged(); }
    private void ChangePage(int page) { currentPage = page; LoadCurrentPage(); }
    private void FilterBySubCat(string? subCat) { selectedSubCat = subCat; ApplyFilters(); }
    private void FilterByColor(string color) { selectedColor = (selectedColor == color) ? null : color; ApplyFilters(); }
    private void SortProducts(ChangeEventArgs e) { sortOption = e.Value?.ToString() ?? "default"; ApplyFilters(); }
    private void ResetFilters() { selectedSubCat = null; minPrice = null; maxPrice = null; selectedColor = null; sortOption = "default"; ApplyFilters(); }
}