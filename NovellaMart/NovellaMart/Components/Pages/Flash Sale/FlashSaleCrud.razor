@page "/flash-sales"
@rendermode InteractiveServer

@using NovellaMart.Core.BL.Model_Classes
@using NovellaMart.Core.BL.Services
@inject NavigationManager Nav
@inject FlashSaleCrudService FlashSaleService
@inject ProductService ProductService
@inject ProductCatalogService ProductCatalogService
@using NovellaMart.Core.BL.UI_Extensions

<div class="page-title">
    <h1 style="color: var(--nm-primary);"><i class="fas fa-shield-alt me-2"></i>Flash Sale Management</h1>
    <div class="title-underline"></div>
    <p class="title-subtext">Manage Flash Sales.</p>
</div>

<div class="flash-sale-layout">

    <div class="flash-sale-form card">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }

        <h3>@(isEdit ? "Edit Flash Sale" : "Create Flash Sale")</h3>

        <input placeholder="Title" @bind="currentSale.title" class="form-control mb-2" />
        <textarea placeholder="Description" @bind="currentSale.description" class="form-control mb-2"></textarea>

        <label>Discount (%)</label>
        <input type="number" min="1" max="90" @bind="currentSale.discount" class="form-control mb-3" />

        <h4>Flash Sale Products</h4>

        <label>Select Category</label>
        <select @onchange="OnCategoryChanged" class="form-select mb-2">
            <option value="-1">-- Select Category --</option>
            @foreach (var cat in categories)
            {
                <option value="@cat.category_id">@cat.name</option>
            }
        </select>

        <label>Select Subcategory</label>
        <select @onchange="OnSubCategoryChanged" disabled="@(!subCategories.Any())" class="form-select mb-3">
            <option value="-1">-- Select Subcategory --</option>
            @foreach (var sub in subCategories)
            {
                <option value="@sub.category_id">@sub.name</option>
            }
        </select>

        @if (filteredProducts.Count > 0)
        {
            <div class="product-scroll-box">
                @foreach (var product in filteredProducts)
                {
                    <div class="product-select-row">
                        <input class="product-checkbox"
                        type="checkbox"
                        checked="@selectedProductIds.Contains(product.product_id)"
                        @onchange="e => ToggleProduct(product, e)" />

                        <div class="product-text">
                            <span class="product-name">@product.name</span>
                            <span class="product-price">(Rs. @product.price)</span>
                        </div>
                    </div>
                }
            </div>
        }
        else if (selectedCategoryId != -1)
        {
            <p class="text-muted mt-2" style="font-size:0.9rem;">
                @(subCategories.Any() ? "Please select a subcategory." : "No products found in this category.")
            </p>
        }

        <label class="mt-3">Start Time</label>
        <input type="datetime-local" @bind="startTimeLocal" class="form-control mb-2" />

        <label>End Time</label>
        <input type="datetime-local" @bind="endTimeLocal" class="form-control mb-3" />

        <div class="status-badge @currentSale.status.ToLower()">
            @currentSale.status
        </div>

        <div class="form-actions mt-3">
            <button class="btn-primary" @onclick="SaveFlashSale">
                @(isEdit ? "Update" : "Create")
            </button>

            @if (isEdit)
            {
                <button class="btn-secondary" @onclick="ResetForm">
                    Cancel
                </button>
            }
        </div>
    </div>

    <div class="flash-sale-list card">
        <h3>Existing Flash Sales</h3>

        @if (flashSales.Count == 0)
        {
            <p class="empty-text">No flash sales created yet.</p>
        }
        else
        {
            @foreach (var sale in flashSales)
            {
                <div class="flash-sale-row">
                    <div>
                        <strong>@sale.title</strong>
                        <div class="muted">@sale.status</div>
                    </div>

                    <div class="row-actions">
                        <button class="btn-stat" @onclick='() => Nav.NavigateTo($"/admin/flash-sale-stats/{sale.flash_sale_id}")'>
                            Stats
                        </button>
                        <button class="btn-stat" style="background-color: #5ff4ef; color: #005f5f; border: none; margin-left: 5px;"
                        @onclick='() => Nav.NavigateTo($"/admin/flash-sale-allocation/{sale.flash_sale_id}")'>
                            Results
                        </button>

                        <button @onclick="() => EditSale(sale)">Edit</button>
                        <button class="delete-btn" @onclick="() => AskDelete(sale)">Delete</button>

                        @if (showDeleteConfirm && salePendingDelete == sale)
                        {
                            <div class="delete-confirm">
                                <span>Are you sure?</span>
                                <button class="btn-secondary" @onclick="ConfirmDelete">Yes</button>
                                <button class="btn-secondary" @onclick="CancelDelete">No</button>
                            </div>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<ProductBL> allProducts = new();
    private HashSet<int> selectedProductIds = new();

    private List<FlashSaleBL> flashSales = new();
    private FlashSaleBL currentSale = new();
    private bool isEdit;

    // _allAvailableCategories holds ALL categories (Parent + Child)
    private List<CategoryBL> _allAvailableCategories = new();

    // categories holds ONLY what we show in the first dropdown
    private List<CategoryBL> categories = new();

    private List<CategoryBL> subCategories = new();
    private List<ProductBL> filteredProducts = new();

    private int selectedCategoryId = -1;
    private int selectedSubCategoryId = -1;

    private DateTime startTimeLocal;
    private DateTime endTimeLocal;

    private FlashSaleBL salePendingDelete;
    private bool showDeleteConfirm;
    private string errorMessage = "";

    private Dictionary<string, List<string>> SubCatMap = new()
    {
        { "Skincare", new() { "Cleansers", "Serums", "Moisturizers", "Sunscreen", "Masks" } },
        { "Cosmetics", new() { "Face", "Eyes", "Lips", "Nails", "Tools" } },
        { "Woman Wear", new() { "Dresses", "Tops", "Bottoms", "Outerwear", "Activewear" } },
        { "Accessories", new() { "Jewellery", "Watches", "Bags", "Eyewear", "Scarves" } }
    };

    protected override async Task OnInitializedAsync()
    {
        // 1. Ensure product data is fully loaded from the JSON source
        await ProductCatalogService.LoadProductsAsync();
        allProducts = ProductCatalogService.MasterProductList.ToList();

        // 2. Load existing sales for the admin list
        flashSales = FlashSaleService.GetAllFlashSales();

        // 3. EXTRACT CATEGORIES DIRECTLY FROM PRODUCTS
        // This handles the case where categories are only defined inside product objects
        _allAvailableCategories = allProducts
            .Where(p => p.category != null)
            .Select(p => p.category)
            .GroupBy(c => c.name)
            .Select(g => g.First())
            .ToList();

        // 4. FILTER FOR MAIN ROOTS (The 4 keys in your SubCatMap)
        // This populates your 'categories' list for the first dropdown
        var rootNames = SubCatMap.Keys.ToList();
        categories = _allAvailableCategories
            .Where(c => rootNames.Any(r => r.Equals(c.name, StringComparison.OrdinalIgnoreCase)))
            .ToList();

        // 5. If extraction fails, manually seed root objects from SubCatMap keys
        if (!categories.Any())
        {
            categories = rootNames.Select(name => new CategoryBL
                {
                    name = name,
                    category_id = name.GetHashCode()
                }).ToList();
        }

        ResetForm();
    }

    private void SaveFlashSale()
    {
        errorMessage = "";
        if (string.IsNullOrWhiteSpace(currentSale.title))
            errorMessage = "Title is required.";
        else if (string.IsNullOrWhiteSpace(currentSale.description))
            errorMessage = "Description is required.";
        else if (startTimeLocal >= endTimeLocal)
            errorMessage = "End time must be after start time.";
        else if (currentSale.fs_items.Count() == 0)
            errorMessage = "Please select at least one product.";
        else if (currentSale.discount <= 0)
            errorMessage = "Discount must be greater than 0.";

        if (!string.IsNullOrEmpty(errorMessage))
            return;

        currentSale.startTime = startTimeLocal;
        currentSale.endTime = endTimeLocal;
        currentSale.UpdateStatus();

        if (isEdit)
            FlashSaleService.UpdateFlashSale(currentSale);
        else
            FlashSaleService.AddFlashSale(currentSale);

        flashSales = FlashSaleService.GetAllFlashSales();
        ResetForm();
    }

    private void EditSale(FlashSaleBL sale)
    {
        currentSale = sale;
        startTimeLocal = sale.startTime;
        endTimeLocal = sale.endTime;

        selectedProductIds.Clear();
        foreach (var p in sale.fs_items)
            selectedProductIds.Add(p.product_id);

        filteredProducts = allProducts
            .Where(p => selectedProductIds.Contains(p.product_id))
            .ToList();

        selectedCategoryId = -1;
        isEdit = true;
    }

    private void AskDelete(FlashSaleBL sale)
    {
        salePendingDelete = sale;
        showDeleteConfirm = true;
    }

    private void ConfirmDelete()
    {
        FlashSaleService.DeleteFlashSale(salePendingDelete.flash_sale_id);
        flashSales = FlashSaleService.GetAllFlashSales();
        salePendingDelete = null;
        showDeleteConfirm = false;
    }

    private void CancelDelete()
    {
        salePendingDelete = null;
        showDeleteConfirm = false;
    }

    private void ResetForm()
    {
        currentSale = new FlashSaleBL();
        selectedProductIds.Clear();

        startTimeLocal = DateTime.Now;
        endTimeLocal = DateTime.Now.AddHours(1);

        currentSale.startTime = startTimeLocal;
        currentSale.endTime = endTimeLocal;
        currentSale.UpdateStatus();

        filteredProducts.Clear();
        subCategories.Clear();
        isEdit = false;
        selectedCategoryId = -1;
        selectedSubCategoryId = -1;
    }

    private void ToggleProduct(ProductBL product, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked)
        {
            if (!selectedProductIds.Contains(product.product_id))
            {
                selectedProductIds.Add(product.product_id);

                // 1. Get the actual master stock from the loaded catalog [cite: 238-239]
                var masterProduct = allProducts.FirstOrDefault(p => p.product_id == product.product_id);
                int totalAvailable = masterProduct?.stock ?? 0;

                // 2. Determine the upper limit for the random generator (Max 5 or totalAvailable)
                int upperLimit = Math.Min(3, totalAvailable);

                // 3. Randomly generate stock between 1 and the upperLimit
                Random rand = new Random();
                int flashSaleStock = upperLimit > 0 ? rand.Next(1, upperLimit + 1) : 0;

                // 4. Create a copy for the sale to protect the master product's data
                var saleItem = new ProductBL
                    {
                        product_id = product.product_id,
                        name = product.name,
                        images = product.images,
                        price = product.price,
                        stock = flashSaleStock, // Randomly assigned 1-5
                        category = product.category,
                        tags = product.tags
                    };
                currentSale.fs_items.InsertAtEnd(saleItem);
            }
        }
        else
        {
            selectedProductIds.Remove(product.product_id);
            var node = currentSale.fs_items.head;
            while (node != null)
            {
                if (node.Data.product_id == product.product_id)
                {
                    currentSale.fs_items.Remove(node.Data);
                    break;
                }
                node = node.Next;
            }
        }
    }

    // --- UPDATED CATEGORY LOGIC ---
    private void OnCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value.ToString(), out int id))
        {
            selectedCategoryId = id;
            var selectedCategory = categories.FirstOrDefault(c => c.category_id == id);
            string selectedCatName = selectedCategory?.name ?? "";

            // Filter the global product list to find unique subcategories belonging to this root
            subCategories = allProducts
                .Where(p => p.tags != null && p.tags.FindNode(selectedCatName))
                .Select(p => p.category)
                .Where(c => c.name != selectedCatName)
                .GroupBy(c => c.name)
                .Select(g => g.First())
                .ToList();

            // If data structure is missing sub-links, generate from SubCatMap
            if (!subCategories.Any() && !string.IsNullOrEmpty(selectedCatName))
            {
                if (SubCatMap.ContainsKey(selectedCatName))
                {
                    subCategories = SubCatMap[selectedCatName]
                        .Select(name => new CategoryBL
                            {
                                name = name,
                                category_id = name.GetHashCode(),
                                parent_category_id = selectedCategoryId
                            })
                        .ToList();
                }
            }

            filteredProducts.Clear();
            selectedSubCategoryId = -1;
        }
    }

    private void OnSubCategoryChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value.ToString(), out int id))
        {
            selectedSubCategoryId = id;
            if (selectedSubCategoryId == -1) { filteredProducts.Clear(); return; }

            var subCategory = subCategories.FirstOrDefault(sc => sc.category_id == selectedSubCategoryId);

            if (subCategory != null)
            {
                // If the subcategory has products attached, use them
                if (subCategory.products != null && subCategory.products.Count() > 0)
                {
                    filteredProducts = subCategory.products.ToList();
                }
                else
                {
                    // Otherwise, filter the global product list by tag name
                    filteredProducts = allProducts
                        .Where(p => p.tags != null && p.tags.FindNode(subCategory.name))
                        .ToList();
                }
            }
        }
    }
}