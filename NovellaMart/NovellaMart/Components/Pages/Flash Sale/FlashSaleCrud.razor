@page "/flash-sales"
@rendermode InteractiveServer

@using NovellaMart.Core.BL.Model_Classes
@using NovellaMart.Core.BL.Services
@inject NavigationManager Nav
@inject FlashSaleCrudService FlashSaleService
@inject ProductService ProductService
@inject ProductCatalogService ProductCatalogService
@using NovellaMart.Core.BL.UI_Extensions

@* <h1 class="page-title"><b>Flash Sale Management</b> </h1> *@
<div class="page-title">
    <h1 style="color: var(--nm-primary);"><i class="fas fa-shield-alt me-2"></i>Flash Sale Management</h1>
    <div class="title-underline"></div>
    <p class="title-subtext">Manage Flash Sales.</p>
</div>


<div class="flash-sale-layout">

    <!-- LEFT: Create / Edit Flash Sale -->
    <div class="flash-sale-form card">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="danger">@errorMessage</div>
        }

        <h3>@(isEdit ? "Edit Flash Sale" : "Create Flash Sale")</h3>

        <input placeholder="Title" @bind="currentSale.title" />
        <textarea placeholder="Description" @bind="currentSale.description"></textarea>
        <label>Discount (%)</label>
        <input type="number" min="1" max="90" @bind="currentSale.discount" />


        <h4>Flash Sale Products</h4>

        <label>Select Category</label>
        <select @onchange="OnCategoryChanged">
            <option value="-1">-- Select Category --</option>
            @foreach (var cat in categories)
            {
                <option value="@cat.category_id">@cat.name</option>
            }
        </select>

        <label>Select Subcategory</label>
        <select @onchange="OnSubCategoryChanged" disabled="@(!subCategories.Any())">
            <option value="-1">-- Select Subcategory --</option>
            @foreach (var sub in subCategories)
            {
                <option value="@sub.category_id">@sub.name</option>
            }
        </select>



        @if (filteredProducts.Count > 0)
        {
            <div class="product-scroll-box">
                @foreach (var product in filteredProducts)
                {
                    <div class="product-select-row">
                        <input class="product-checkbox"
                        type="checkbox"
                        checked="@selectedProductIds.Contains(product.product_id)"
                        @onchange="e => ToggleProduct(product, e)" />

                        <div class="product-text">
                            <span class="product-name">@product.name</span>
                            <span class="product-price">(Rs. @product.price)</span>
                        </div>
                    </div>

                }
            </div>
        }


        <label>Start Time</label>
        <input type="datetime-local" @bind="startTimeLocal" />

        <label>End Time</label>
        <input type="datetime-local" @bind="endTimeLocal" />

        <div class="status-badge @currentSale.status.ToLower()">
            @currentSale.status
        </div>

        <div class="form-actions">
            <button class="btn-primary" @onclick="SaveFlashSale">
                @(isEdit ? "Update" : "Create")
            </button>

            @if (isEdit)
            {
                <button class="btn-secondary" @onclick="ResetForm">
                    Cancel
                </button>
            }
        </div>

    </div>

    <!-- RIGHT: Flash Sale List -->
    <div class="flash-sale-list card">
        <h3>Existing Flash Sales</h3>

        @if (flashSales.Count == 0)
        {
            <p class="empty-text">No flash sales created yet.</p>
        }
        else
        {
            @foreach (var sale in flashSales)
            {
                <div class="flash-sale-row">
                    <div>
                        <strong>@sale.title</strong>
                        <div class="muted">@sale.status</div>
                    </div>

                    <div class="row-actions">
                        <button class="btn-stat" @onclick='() => Nav.NavigateTo($"/admin/flash-sale-stats/{sale.flash_sale_id}")'>
                            Stats
                        </button>
                        <button class="btn-stat" style="background-color: #5ff4ef; color: #005f5f; border: none; margin-left: 5px;"
                                @onclick='() => Nav.NavigateTo($"/admin/flash-sale-allocation/{sale.flash_sale_id}")'>
                             Results
                        </button>
                    
                        <button @onclick="() => EditSale(sale)">Edit</button>
                        <button class="delete-btn" @onclick="() => AskDelete(sale)">Delete</button>
                        @if (showDeleteConfirm && salePendingDelete == sale)
                        {
                            <div class="delete-confirm">
                                <span>Are you sure?</span>
                                <button class="btn-secondary" @onclick="ConfirmDelete">Yes</button>
                                <button class="btn-secondary" @onclick="CancelDelete">No</button>
                            </div>
                        }


                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<ProductBL> allProducts = new();
    private HashSet<int> selectedProductIds = new();

    private List<FlashSaleBL> flashSales = new();
    private FlashSaleBL currentSale = new();
    private bool isEdit;

    private List<CategoryBL> categories = new();
    private int selectedCategoryId = -1;
    private List<ProductBL> filteredProducts = new();

    private DateTime startTimeLocal;
    private DateTime endTimeLocal;

    private FlashSaleBL salePendingDelete;
    private bool showDeleteConfirm;

    private int selectedSubCategoryId = -1;
    private List<CategoryBL> subCategories = new();



    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await ProductCatalogService.LoadProductsAsync();

        allProducts = ProductCatalogService.MasterProductList.ToList();

        flashSales = FlashSaleService.GetAllFlashSales();

        // categories = allProducts
        // .Where(p => p.category != null && p.category.parent_category_id == 0)
        // .Select(p => p.category)
        // .GroupBy(c => c.category_id)
        // .Select(g => g.First())
        // .ToList();

        categories = ProductCatalogService.MasterCategoryList.ToList();

        ResetForm();
    }

    private void SaveFlashSale()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(currentSale.title))
            errorMessage = "Title is required.";
        else if (string.IsNullOrWhiteSpace(currentSale.description))
            errorMessage = "Description is required.";
        else if (startTimeLocal >= endTimeLocal)
            errorMessage = "End time must be after start time.";
        else if (currentSale.fs_items.Count() == 0)
            errorMessage = "Please select at least one product.";
        else if (currentSale.discount <= 0)
            errorMessage = "Discount must be greater than 0.";

        if (!string.IsNullOrEmpty(errorMessage))
            return;

        currentSale.startTime = startTimeLocal;
        currentSale.endTime = endTimeLocal;
        currentSale.UpdateStatus();

        if (isEdit)
            FlashSaleService.UpdateFlashSale(currentSale);
        else
            FlashSaleService.AddFlashSale(currentSale);

        flashSales = FlashSaleService.GetAllFlashSales();
        ResetForm();
    }



    private void EditSale(FlashSaleBL sale)
    {
        filteredProducts = allProducts
    .Where(p => selectedProductIds.Contains(p.product_id))
    .ToList();

        currentSale = sale;
        startTimeLocal = sale.startTime;
        endTimeLocal = sale.endTime;

        selectedProductIds.Clear();
        foreach (var p in sale.fs_items)
            selectedProductIds.Add(p.product_id);

        selectedCategoryId = -1;
        filteredProducts.Clear();

        isEdit = true;
    }

    private void AskDelete(FlashSaleBL sale)
    {
        salePendingDelete = sale;
        showDeleteConfirm = true;
    }

    private void ConfirmDelete()
    {
        FlashSaleService.DeleteFlashSale(salePendingDelete.flash_sale_id);
        flashSales = FlashSaleService.GetAllFlashSales();
        salePendingDelete = null;
        showDeleteConfirm = false;
    }

    private void CancelDelete()
    {
        salePendingDelete = null;
        showDeleteConfirm = false;
    }

    private void DeleteSale(FlashSaleBL sale)
    {
        FlashSaleService.DeleteFlashSale(sale.flash_sale_id);
        flashSales = FlashSaleService.GetAllFlashSales();
    }

    private void ResetForm()
    {
        currentSale = new FlashSaleBL();

        selectedProductIds.Clear();

        startTimeLocal = DateTime.Now;
        endTimeLocal = DateTime.Now.AddHours(1);

        currentSale.startTime = startTimeLocal;
        currentSale.endTime = endTimeLocal;
        currentSale.UpdateStatus();

        isEdit = false;
    }


    private void ToggleProduct(ProductBL product, ChangeEventArgs e)
    {
        bool isChecked = e.Value is bool b && b;

        if (isChecked)
        {
            if (!selectedProductIds.Contains(product.product_id))
            {
                selectedProductIds.Add(product.product_id);
                currentSale.fs_items.InsertAtEnd(product);
            }
        }
        else
        {
            selectedProductIds.Remove(product.product_id);
            currentSale.fs_items.Remove(product);
        }
    }

    private void OnCategoryChanged(ChangeEventArgs e)
    {
        selectedCategoryId = int.Parse(e.Value.ToString());

        var parentCategory = categories
            .FirstOrDefault(c => c.category_id == selectedCategoryId);

        subCategories = parentCategory != null
            ? parentCategory.subcategories.ToList()
            : new List<CategoryBL>();

        filteredProducts.Clear();
    }


    private void OnSubCategoryChanged(ChangeEventArgs e)
    {
        selectedSubCategoryId = int.Parse(e.Value.ToString());

        if (selectedSubCategoryId == -1)
        {
            filteredProducts.Clear();
            return;
        }

        var subCategory = subCategories
            .FirstOrDefault(sc => sc.category_id == selectedSubCategoryId);

        filteredProducts = subCategory != null
            ? subCategory.products.ToList()
            : new List<ProductBL>();
    }

}
