@page "/flash-sale/{Id:int}"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Model_Classes
@using NovellaMart.Core.BL.Services
@inject FlashSaleService LiveSaleService
@inject FlashSaleCrudService CrudService
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime
@implements IDisposable

@* Flash Sale *@
<div class="page-title">
    <h1 style="color: var(--nm-primary);">@currentSale?.title</h1>
    <div class="title-underline"></div>
    <p class="title-subtext">
        <i class="fas fa-bolt me-1" style="color: #f1ee56;"></i> @currentSale?.description |
        <i class="fas fa-clock ms-3 me-1"></i> Ends in:
        <span style="font-weight:700; color:#333;">@GetTimeRemaining()</span>
    </p>
</div>

<div class="container mb-5">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        @{
            var sale = LiveSaleService.GetActiveSale();
            var node = sale?.fs_items?.head;
        }

        @while (node != null)
        {
            var product = node.Data;

            string myStatus = LiveSaleService.GetUserStatus(currentUserId, product.product_id);
            bool isJoined = (myStatus == "Queued" || myStatus == "Allocated");

            // Dynamic Price calculation based on the specific Flash Sale's discount
            double discountedPrice = product.price * (1 - (currentSale.discount / 100.0));

            <div class="col">
                @*  <!-- 2. Card Style --> *@

                <div class="cart-card h-100 p-3 d-flex flex-column align-items-center position-relative"
                     style="padding: 1.5rem !important; transition: transform 0.2s;">

                    @*  <!-- 3. Image Frame --> *@
                    <div class="img-frame mb-3" style="width: 100%; height: 180px; display: flex; align-items: center; justify-content: center; background: white;">
                        <img src="@(product.images != null && product.images.Length > 0 ? product.images[0] : "https://via.placeholder.com/140")"
                             style="max-height: 140px; max-width: 90%; object-fit: contain;" />

                        <span class="badge rounded-pill"
                              style="position: absolute; top: 15px; right: 15px; background: linear-gradient(45deg, #ff3333, #ff6b6b); font-size: 0.7rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                            HOT
                        </span>
                    </div>

                    <div class="text-center w-100 d-flex flex-column flex-grow-1">
                        <h5 style="font-size: 1rem; font-weight: 700; color: #444; height: 2.4em; overflow: hidden; margin-bottom: 0.5rem;">
                            @product.name
                        </h5>

                        <div class="mb-2">
                            <span style="text-decoration: line-through; color: #bbb; font-size: 0.9rem; margin-right: 5px;">Rs. @product.price.ToString("N0")</span>
                            <span style="color: var(--nm-primary); font-weight: 700; font-size: 1.2rem;">Rs. @discountedPrice.ToString("N0")</span>
                        </div>

                        <div class="mt-auto w-100">
                            <div class="d-flex justify-content-between mb-1" style="font-size: 0.7rem; font-weight: 700; color: #666; text-transform: uppercase;">
                                <span>Stock Left</span>
                                <span class="text-danger">@product.stock</span>
                            </div>
                            <div class="progress mb-3" style="height: 6px; border-radius: 10px; background-color: #f0f0f0;">
                                <div class="progress-bar" style="width: @(product.stock > 0 ? "60%" : "0%"); background: linear-gradient(90deg, var(--nm-primary), var(--nm-accent)); border-radius: 10px;"></div>
                            </div>

                            @if (isJoined)
                            {
                                <button class="btn w-100 py-2 btn-leave"
                                        @onclick="() => ToggleQueue(product.product_id)">
                                    <i class="fas fa-times-circle me-1"></i> UNJOIN QUEUE
                                </button>

                                @* <div class="mt-2 text-center" style="font-size: 0.7rem; color: #28a745; font-weight: 600;"> *@
                                @*     <i class="fas fa-check-circle"></i> Status: @myStatus *@
                                @* </div> *@
                            }
                            else
                            {
                                <button class="btn-checkout-glow w-100 py-2"
                                        style="margin-top: 0; font-size: 0.9rem; padding: 0.8rem;"
                                        @onclick="() => ToggleQueue(product.product_id)"
                                        disabled="@(product.stock <= 0)">
                                    <i class="fas fa-bolt me-1"></i> @(product.stock > 0 ? "REQUEST PURCHASE" : "SOLD OUT")
                                </button>
                            }
                        </div>
                    </div>
                </div>
                        @* <button class="btn btn-warning" @onclick="ProcessResults">End Sale & Allocate Stock</button> *@
            </div>
            node = node.Next;
        }
    </div>
</div>

<style>
    /* Styling for the Leave Button */
    .btn-leave {
        margin-top: 0;
        font-size: 0.9rem;
        padding: 0.8rem;
        background-color: #f8f9fa;
        color: #dc3545;
        border: 2px solid #dc3545;
        border-radius: 30px;
        font-weight: 700;
        transition: all 0.2s;
    }

        .btn-leave:hover {
            background-color: #dc3545;
            color: white;
        }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private FlashSaleBL currentSale;
    private int currentUserId;
    private System.Timers.Timer _refreshTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // FIX: Explicitly passing the string as an argument for the JS 'getItem' function
            var storedId = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", new object[] { "userId" });

            if (string.IsNullOrEmpty(storedId))
            {
                Nav.NavigateTo("/login");
            }
            else
            {
                // Parse to int to use with your services
                if (int.TryParse(storedId, out int parsedId))
                {
                    currentUserId = parsedId;
                    StateHasChanged(); // Refresh UI to show "Join" or "Joined" status
                }
            }
        }
    }


    protected override void OnInitialized()
    {
        currentSale = CrudService.GetAllFlashSales().FirstOrDefault(s => s.flash_sale_id == Id);

        if (currentSale != null)
        {
            LiveSaleService.SetActiveSale(currentSale);
        }
        _refreshTimer = new System.Timers.Timer(1000);
        _refreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        _refreshTimer.Start();
    }

    // Inside FlashSale.razor @code block
    private async Task ToggleQueue(int productId)
    {
        if (currentUserId == 0)
        {
            var storedId = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "userId");
            if (string.IsNullOrEmpty(storedId)) { Nav.NavigateTo("/login"); return; }
            currentUserId = int.Parse(storedId);
        }

        string status = LiveSaleService.GetUserStatus(currentUserId, productId);
        if (status == "Queued" || status == "Allocated")
        {
            LiveSaleService.LeaveFlashSaleQueue(currentUserId, productId);
        }
        else
        {
            // Ensure this method in your service adds the user to the Circular Queue
            LiveSaleService.JoinFlashSaleQueue(new CustomerBL { user_id = currentUserId }, productId);
        }
        StateHasChanged();
    }

    private string GetTimeRemaining()
    {
        if (currentSale == null) return "00:00:00";
        var span = currentSale.endTime - DateTime.Now;
        return span.Ticks > 0
            ? $"{(int)span.TotalHours:D2}:{span.Minutes:D2}:{span.Seconds:D2}"
            : "ENDED";
    }

    public void Dispose() => _refreshTimer?.Dispose();

    private void ProcessResults()
    {
        LiveSaleService.FinalizeAllocations();
        StateHasChanged();
    }
}