@page "/admin/flash-sale-stats/{Id:int}"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Services
@using NovellaMart.Core.BL.Model_Classes
@inject FlashSaleService LiveQueueService
@inject FlashSaleCrudService SaleDataService
@implements IDisposable

@* Flash Sale Stats *@
<div class="page-title">
    <h1 style="color: var(--nm-primary);"><i class="fas fa-chart-line me-2"></i>Sale Statistics</h1>
    <div class="title-underline"></div>
    <p class="title-subtext">Monitoring: <b>@currentSale?.title</b></p>
</div>

<div class="container admin-container" style="max-width: 900px; padding-bottom: 80px;">

    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <div class="stats-timer-container">
                <div class="timer-pill">
                    <i class="fas fa-clock"></i> @GetTimeRemaining()
                </div>
            </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <button class="btn-allocate-themed" @onclick="FinalizeAllocations">
                <i class="fas fa-gavel me-2"></i> Allocate Products Manually
            </button>
        </div>
    </div>

    <div class="row">
        @if (currentSale?.fs_items != null)
        {
            var node = currentSale.fs_items.head;
            while (node != null)
            {
                var p = node.Data;

                bool isExpanded = expandedProductId == p.product_id;
                int queueSize = (p != null) ? LiveQueueService.GetQueueCount(p.product_id) : 0;

                <div class="col-12 mb-3">
                    <div class="checkout-card p-0 overflow-hidden shadow-sm @(isExpanded ? "admin-card-expanded" : "admin-card-default")">

                        <div class="d-flex align-items-center justify-content-between p-3" style="cursor: pointer;" @onclick="() => ToggleQueue(p.product_id)">
                            <div class="d-flex align-items-center">
                                <div class="admin-product-img-wrapper me-3">
                                    <img src="@p.images[0]" alt="@p.name" />
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">@p.name</h6>
                                    <div class="d-flex gap-2 mt-1">
                                        <span class="badge bg-light text-muted border">Stock: @p.stock</span>
                                        <span class="badge badge-queue-count">In Queue: @queueSize</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn @(isExpanded ? "btn-admin-close" : "btn-admin-toggle")">
                                <i class="fas @(isExpanded ? "fa-times" : "fa-users") me-1"></i>
                                @(isExpanded ? "Close" : "View Line")
                            </button>
                        </div>

                        @if (isExpanded)
                        {
                            <div class="p-0 bg-white border-top animate-dropdown">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="admin-table-thead">
                                            <tr>
                                                @* Applied classes to headers for consistent spacing *@
                                                <th class="col-serial">#</th>
                                                <th>Customer ID</th>
                                                <th>Join Time</th>
                                                <th class="col-status">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var queueItems = LiveQueueService.GetQueueSnapshot(p.product_id);
                                                int rank = 1;
                                            }

                                            @if (queueItems == null || !queueItems.Any())
                                            {
                                                <tr>
                                                    <td colspan="4">
                                                        <div class="empty-queue-container text-center py-4">
                                                            <i class="fas fa-inbox mb-2" style="color: #ccc; font-size: 1.5rem;"></i>
                                                            <p class="text-muted mb-0">No customers in line yet.</p>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @foreach (var request in queueItems)
                                                {
                                                    <tr>
                                                        <td class="col-serial"><span class="queue-serial">#@rank</span></td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-user-circle me-2 text-primary"></i>
                                                                <span class="fw-bold">User: @request.customer.user_id</span>
                                                            </div>
                                                        </td>
                                                        <td class="join-time-text">@request.requestTime.ToString("HH:mm:ss")</td>
                                                        <td class="col-status">
                                                            @{
                                                                var status = LiveQueueService.GetUserStatus(request.customer.user_id, p.product_id);
                                                            }
                                                            @if (status == "Ordered")
                                                            {
                                                                <span class="badge rounded-pill bg-info">Ordered (Verified)</span>
                                                            }
                                                            else if (status == "Allocated")
                                                            {
                                                                <span class="badge rounded-pill bg-success">Allocated</span>
                                                            }
                                                            else if (status == "Expired")
                                                            {
                                                                <span class="badge rounded-pill bg-secondary text-white">Expired</span>
                                                            }
                                                            else if (status == "Rejected")
                                                            {
                                                                <span class="badge rounded-pill bg-danger">Rejected</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge rounded-pill bg-warning text-dark">Waiting</span>
                                                            }
                                                        </td>
                                                    </tr>
                                                    rank++;
                                                }
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                node = node.Next;
            }
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private FlashSaleBL currentSale;
    private int expandedProductId = -1;
    private System.Timers.Timer _refreshTimer;

    protected override void OnInitialized()
    {
        currentSale = SaleDataService.GetAllFlashSales().FirstOrDefault(s => s.flash_sale_id == Id);
        if (currentSale != null)
        {
            LiveQueueService.SetActiveSale(currentSale);
        }

        _refreshTimer = new System.Timers.Timer(1000);

        _refreshTimer.Elapsed += async (s, e) =>
        {
            LiveQueueService.ReleaseExpiredAllocations();

            if (currentSale != null)
            {
                var span = currentSale.endTime - DateTime.Now;
                if (span.Ticks <= 0 && currentSale.status == "ACTIVE")
                {
                    await FinalizeAllocations();
                }
            }
            await InvokeAsync(StateHasChanged);
        };

        _refreshTimer.Start();
    }

    private async Task FinalizeAllocations()
    {
        Console.WriteLine("Manual Allocation Triggered");
        LiveQueueService.ReleaseExpiredAllocations();
        LiveQueueService.FinalizeAllocations();
        await InvokeAsync(StateHasChanged);
    }

    private string GetTimeRemaining()
    {
        if (currentSale == null) return "00:00:00";
        var span = currentSale.endTime - DateTime.Now;
        return span.Ticks > 0 ? $"{(int)span.TotalHours:D2}h {span.Minutes:D2}m {span.Seconds:D2}s" : "ENDED";
    }

    

    private void ToggleQueue(int productId)
    {
        expandedProductId = (expandedProductId == productId) ? -1 : productId;
    }

    public void Dispose() => _refreshTimer?.Dispose();
}