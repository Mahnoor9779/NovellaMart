@page "/admin/flash-sale-stats/{Id:int}"
@rendermode InteractiveServer
@using NovellaMart.Core.BL.Services
@using NovellaMart.Core.BL.Model_Classes
@inject FlashSaleService LiveQueueService
@inject FlashSaleCrudService SaleDataService
@implements IDisposable

<div class="page-title">
    <h1 style="color: var(--nm-primary);"><i class="fas fa-chart-line me-2"></i>Sale Statistics</h1>
    <div class="title-underline"></div>
    <p class="title-subtext">Monitoring: <b>@currentSale?.title</b></p>
</div>

<div class="container admin-container" style="max-width: 900px; padding-bottom: 80px;">

    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <div class="stats-timer-container">
                <div class="timer-pill">
                    <i class="fas fa-clock"></i> @GetTimeRemaining()
                </div>
            </div>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
            <button class="btn-allocate-themed" @onclick="FinalizeAllocations">
                <i class="fas fa-gavel me-2"></i> Allocate Products Manually
            </button>
        </div>
    </div>

    <div class="row">
        @if (currentSale?.fs_items != null)
        {
            var node = currentSale.fs_items.head;
            while (node != null)
            {
                var p = node.Data;
                bool isExpanded = expandedProductId == p.product_id;
                int queueSize = LiveQueueService.GetQueueCount(p.product_id);

                <div class="col-12 mb-3">
                    <div class="checkout-card p-0 overflow-hidden shadow-sm @(isExpanded ? "admin-card-expanded" : "admin-card-default")">

                        <div class="d-flex align-items-center justify-content-between p-3" style="cursor: pointer;" @onclick="() => ToggleQueue(p.product_id)">
                            <div class="d-flex align-items-center">
                                <div class="admin-product-img-wrapper me-3">
                                    <img src="@p.images[0]" alt="@p.name" />
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">@p.name</h6>
                                    <div class="d-flex gap-2 mt-1">
                                        <span class="badge bg-light text-muted border">Stock: @p.stock</span>
                                        <span class="badge badge-queue-count">In Queue: @queueSize</span>
                                    </div>
                                </div>
                            </div>
                            <button class="btn @(isExpanded ? "btn-admin-close" : "btn-admin-toggle")">
                                <i class="fas @(isExpanded ? "fa-times" : "fa-users") me-1"></i>
                                @(isExpanded ? "Close" : "View Line")
                            </button>
                        </div>

                        @if (isExpanded)
                        {
                            <div class="p-0 bg-white border-top animate-dropdown">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="admin-table-thead">
                                            <tr>
                                                @* Applied classes to headers for consistent spacing *@
                                                <th class="col-serial">#</th>
                                                <th>Customer ID</th>
                                                <th>Join Time</th>
                                                <th class="col-status">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (queueSize == 0)
                                            {
                                                <tr>
                                                    <td colspan="4">
                                                        <div class="empty-queue-container">
                                                            <i class="fas fa-inbox empty-drawer-icon"></i>
                                                            <span class="empty-text">Queue is currently empty.</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                            else
                                            {
                                                @* Example row mapping real classes *@
                                                <tr>
                                                    <td class="col-serial"><span class="queue-serial">#1</span></td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <i class="fas fa-user-circle me-2 icon-user-id"></i>
                                                            <span class="fw-bold">USR_4921</span>
                                                        </div>
                                                    </td>
                                                    <td class="join-time-text">16:04:12</td>
                                                    <td class="col-status">
                                                        <span class="badge rounded-pill status-badge-waiting">Waiting</span>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                node = node.Next;
            }
        }
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private FlashSaleBL currentSale;
    private int expandedProductId = -1;
    private System.Timers.Timer _refreshTimer;

    protected override void OnInitialized()
    {
        currentSale = SaleDataService.GetAllFlashSales().FirstOrDefault(s => s.flash_sale_id == Id);
        if (currentSale != null)
        {
            LiveQueueService.SetActiveSale(currentSale);
        }

        _refreshTimer = new System.Timers.Timer(1000);
        _refreshTimer.Elapsed += (s, e) => InvokeAsync(StateHasChanged);
        _refreshTimer.Start();
    }

    private string GetTimeRemaining()
    {
        if (currentSale == null) return "00:00:00";
        var span = currentSale.endTime - DateTime.Now;
        return span.Ticks > 0 ? $"{(int)span.TotalHours:D2}h {span.Minutes:D2}m {span.Seconds:D2}s" : "ENDED";
    }

    private void FinalizeAllocations()
    {
        LiveQueueService.FinalizeAllocations();
        if (currentSale != null) currentSale.status = "ENDED";
        StateHasChanged();
    }

    private void ToggleQueue(int productId)
    {
        expandedProductId = (expandedProductId == productId) ? -1 : productId;
    }

    public void Dispose() => _refreshTimer?.Dispose();
}